<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Agendamentos e Análise Preditiva</title>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-primary-green: #57da1c;
            --color-secondary-purple: #E54E88;
            --color-dark-blue: #222222;
            --color-accent-orange: #f95b3c;
            --color-accent-teal: #00BFB2;
            --color-accent-yellow: #FDBB2D;
            --color-light-gray-bg: #F0F0F0;
            --color-white: #FFFFFF;
            --color-text-dark: #4A5568;
        }
        
        body {
            font-family: 'Nunito', sans-serif; 
            background-color: var(--color-light-gray-bg); 
            color: var(--color-text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .main-header {
            background: linear-gradient(135deg, var(--color-secondary-purple), var(--color-accent-orange));
            color: var(--color-white);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 15px 40px rgba(229, 78, 136, 0.3);
            margin-bottom: 2rem;
        }

        .main-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .btn-warning, .btn-primary, .btn-export {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            color: var(--color-white);
            text-decoration: none;
            border: none;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin: 0.5rem;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-secondary-purple), var(--color-accent-orange));
        }

        .btn-export {
            background: linear-gradient(135deg, var(--color-accent-teal), var(--color-primary-green));
        }

        .btn-warning:hover, .btn-primary:hover, .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .section-card {
            background: var(--color-white);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            border-left: 6px solid var(--color-secondary-purple);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-accent-orange);
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 700;
            color: var(--color-dark-blue);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-secondary-purple);
        }

        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--color-white);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            border-left: 6px solid var(--color-secondary-purple);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-accent-orange);
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            font-weight: 700;
            color: var(--color-text-dark);
            font-size: 1rem;
        }

        .responsaveis-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .responsavel-card {
            background: var(--color-white);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border-left: 6px solid var(--color-accent-teal);
        }

        .responsavel-nome {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--color-dark-blue);
            margin-bottom: 1rem;
            text-align: center;
        }

        .responsavel-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .metric-item {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--color-text-dark);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-dark-blue);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .empresa-card {
            background: var(--color-white);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-left: 6px solid var(--color-secondary-purple);
            cursor: pointer;
            position: relative;
        }

        .empresa-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .empresa-nome {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--color-dark-blue);
            margin-bottom: 1rem;
        }

        .status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--color-white);
            text-transform: uppercase;
        }

        .metric-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--color-white);
            border-radius: 1rem;
            width: 90vw;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--color-secondary-purple), var(--color-accent-orange));
            color: var(--color-white);
            padding: 2rem;
            border-radius: 1rem 1rem 0 0;
            position: relative;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 800;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--color-white);
            font-size: 1.5rem;
            padding: 0.5rem 1rem;
            border-radius: 50%;
            cursor: pointer;
        }

        .modal-content {
            padding: 2rem;
        }

        .field-group {
            margin-bottom: 1.5rem;
        }

        .field-label {
            font-weight: 700;
            color: var(--color-dark-blue);
            margin-bottom: 0.5rem;
            display: block;
        }

        .field-value {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .field-value:hover {
            background: #e2e8f0;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: var(--color-text-dark);
        }

        /* Relatório */
        .report-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1200px;
            background: white;
            font-family: 'Nunito', sans-serif;
        }

        .report-header {
            background: linear-gradient(135deg, #E54E88, #f95b3c);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .report-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .report-section {
            padding: 1.5rem;
        }

        .report-section h3 {
            color: #E54E88;
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #E54E88;
            padding-bottom: 0.5rem;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .report-kpi {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            border-left: 4px solid #E54E88;
        }

        .report-kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #f95b3c;
        }

        .report-kpi-label {
            font-size: 0.9rem;
            color: #4A5568;
            font-weight: 600;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .report-table th {
            background: #E54E88;
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 700;
        }

        .report-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .report-footer {
            background: #f8fafc;
            padding: 1rem;
            text-align: center;
            color: #4A5568;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .form-grid, .responsaveis-section, .kpi-section, .cards-grid {
                grid-template-columns: 1fr;
            }
            .report-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1>Dashboard de Agendamentos e Análise Preditiva</h1>
            <p>Divisão por Responsável + Funil + Queda</p>
            <div>
                <a href="index.html" class="btn-warning">Voltar</a>
                <button onclick="exportReport()" class="btn-export" id="export-btn">Exportar Relatório PNG</button>
            </div>
        </header>

        <!-- Filtros -->
        <section class="section-card" style="margin-bottom: 1.5rem;">
            <h2 class="section-title">Filtros</h2>
            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="form-group">
                    <label class="form-label">Período</label>
                    <select id="filtro-periodo" class="form-select">
                        <option value="hoje">Hoje</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes">Este Mês</option>
                        <option value="todos" selected>Todo o Período</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Responsável</label>
                    <select id="filtro-responsavel" class="form-select">
                        <option value="">Todos</option>
                        <option value="Erick">Erick</option>
                        <option value="Kauã">Kauã</option>
                        <option value="Bruna Azevedo">Bruna Azevedo</option>
                        <option value="Matheus">Matheus</option>
                        <option value="Eliane">Eliane</option>
                        <option value="Priscila Prado">Priscila Prado</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="button" onclick="aplicarFiltro()" class="btn-primary" style="margin-top: 1.5rem;">Aplicar</button>
                </div>
            </div>
        </section>

        <!-- Formulário -->
        <section class="section-card">
            <h2 class="section-title">Adicionar Novo Agendamento</h2>
            <form id="agendamentoForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Responsável *</label>
                        <select id="responsavel" class="form-select" required>
                            <option value="">Selecione</option>
                            <option value="Erick">Erick</option>
                            <option value="Kauã">Kauã</option>
                            <option value="Bruna Azevedo">Bruna Azevedo</option>
                            <option value="Matheus">Matheus</option>
                            <option value="Eliane">Eliane</option>
                            <option value="Priscila Prado">Priscila Prado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Empresa *</label>
                        <input type="text" id="empresa" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Reunião *</label>
                        <input type="date" id="dataReuniao" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status Negociação</label>
                        <select id="statusNegociacao" class="form-select">
                            <option value="Reunião Agendada" selected>Reunião Agendada</option>
                            <option value="Reunião Realizada">Reunião Realizada</option>
                            <option value="Proposta Enviada">Proposta Enviada</option>
                            <option value="Contrato Enviado">Contrato Enviado</option>
                            <option value="Contrato Assinado">Contrato Assinado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ticket Médio (R$)</label>
                        <input type="number" id="ticketMedio" class="form-input" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nº Lojas</label>
                        <input type="number" id="numeroLojas" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nº Funcionários</label>
                        <input type="number" id="numeroFuncionarios" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Segmento</label>
                        <select id="segmento" class="form-select">
                            <option value="">Selecione</option>
                            <option value="Moda">Moda</option>
                            <option value="Calçados">Calçados</option>
                            <option value="Acessórios">Acessórios</option>
                            <option value="Infantil">Infantil</option>
                            <option value="Decoração">Decoração</option>
                            <option value="Cosméticos">Cosméticos</option>
                            <option value="Esportivo">Esportivo</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Local</label>
                        <input type="text" id="localEvento" class="form-input">
                    </div>
                </div>
                <button type="submit" class="btn-primary">Adicionar</button>
            </form>
        </section>

        <!-- KPIs Gerais -->
        <section class="kpi-section hidden" id="kpis-section">
            <div class="kpi-card"><div class="kpi-value" id="total-agendamentos">0</div><div class="kpi-label">Total</div></div>
            <div class="kpi-card"><div class="kpi-value" id="total-avancou">0</div><div class="kpi-label">Fechados</div></div>
            <div class="kpi-card"><div class="kpi-value" id="total-pendentes">0</div><div class="kpi-label">Pendentes</div></div>
            <div class="kpi-card"><div class="kpi-value" id="taxa-conversao">0%</div><div class="kpi-label">Taxa</div></div>
        </section>

        <!-- KPIs por Responsável -->
        <section class="section-card">
            <h2 class="section-title">Desempenho por Responsável</h2>
            <div id="responsaveis-container" class="responsaveis-section"></div>
        </section>

        <!-- Cards -->
        <section class="section-card">
            <h2 class="section-title">Quadro de Agendamentos</h2>
            <div id="cards-container" class="cards-grid"></div>
        </section>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Empresa</div>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-content" id="modal-content"></div>
        </div>
    </div>

    <script>
        let allData = [], currentRecordId = null, filtroAtual = 'todos', filtroResp = '';
        const API_URL = '/api/expositores3';

        document.getElementById('dataReuniao').valueAsDate = new Date();

        async function loadData() {
            const loading = document.createElement('div');
            loading.className = 'loading'; loading.textContent = 'Carregando...'; document.body.appendChild(loading);
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error();
                const data = await res.json();
                allData = data.records || [];
                aplicarFiltro();
                document.getElementById('kpis-section').classList.remove('hidden');
            } catch { Swal.fire('Erro', 'Falha ao carregar', 'error'); }
            finally { document.body.removeChild(loading); }
        }

        document.getElementById('agendamentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dados = {
                responsavel: document.getElementById('responsavel').value,
                empresa: document.getElementById('empresa').value,
                dataReuniao: document.getElementById('dataReuniao').value,
                statusNegociacao: document.getElementById('statusNegociacao').value || 'Reunião Agendada',
                ticketMedio: parseFloat(document.getElementById('ticketMedio').value) || null,
                numeroLojas: parseInt(document.getElementById('numeroLojas').value) || null,
                numeroFuncionarios: parseInt(document.getElementById('numeroFuncionarios').value) || null,
                segmento: document.getElementById('segmento').value || null,
                localEvento: document.getElementById('localEvento').value || null
            };
            try {
                const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dados) });
                if (!res.ok) throw new Error();
                Swal.fire('Sucesso!', 'Criado', 'success');
                ['empresa','ticketMedio','numeroLojas','numeroFuncionarios','segmento','localEvento'].forEach(id => document.getElementById(id).value = '');
                loadData();
            } catch { Swal.fire('Erro', 'Falha', 'error'); }
        });

        function getStatusColor(status) {
            const cores = {
                'Reunião Agendada': 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                'Reunião Realizada': 'linear-gradient(135deg, #10b981, #059669)',
                'Proposta Enviada': 'linear-gradient(135deg, #3b82f6, #2563eb)',
                'Contrato Enviado': 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                'Contrato Assinado': 'linear-gradient(135deg, #22c55e, #16a34a)'
            };
            return cores[status] || '#9ca3af';
        }

        function renderResponsaveis() {
            const dados = filtrarDados(allData);
            const porResp = {};
            dados.forEach(r => {
                const resp = r.fields.Responsavel || 'Sem responsável';
                if (!porResp[resp]) porResp[resp] = { total: 0, avancou: 0, pendentes: 0 };
                porResp[resp].total++;
                if (r.fields.StatusAvanco === 'Avançou') porResp[resp].avancou++;
                if (r.fields.StatusAvanco === 'Pendente') porResp[resp].pendentes++;
            });

            const container = document.getElementById('responsaveis-container');
            container.innerHTML = Object.entries(porResp).map(([nome, s]) => {
                const taxa = s.total > 0 ? (s.avancou / s.total * 100).toFixed(1) : 0;
                return `<div class="responsavel-card">
                    <div class="responsavel-nome">${nome}</div>
                    <div class="responsavel-metrics">
                        <div class="metric-item"><div class="metric-label">Total</div><div class="metric-value">${s.total}</div></div>
                        <div class="metric-item"><div class="metric-label">Fechados</div><div class="metric-value">${s.avancou}</div></div>
                        <div class="metric-item"><div class="metric-label">Pendentes</div><div class="metric-value">${s.pendentes}</div></div>
                        <div class="metric-item"><div class="metric-label">Taxa</div><div class="metric-value">${taxa}%</div></div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderCards() {
            const dados = filtrarDados(allData);
            const container = document.getElementById('cards-container');
            if (!dados.length) {
                container.innerHTML = `<p style="text-align:center;color:#6b7280;">Nenhum agendamento</p>`;
                return;
            }
            container.innerHTML = dados.map(r => {
                const f = r.fields;
                return `<div class="empresa-card" onclick="openModal('${r.id}')">
                    <div class="empresa-nome">${f.Empresa}</div>
                    <div class="status-badge" style="background:${getStatusColor(f.statusNegociacao)};">${f.statusNegociacao || 'Pendente'}</div>
                    <div class="metric-row">
                        <div class="metric-item"><div class="metric-label">Responsável</div><div class="metric-value">${f.Responsavel}</div></div>
                        <div class="metric-item"><div class="metric-label">Data</div><div class="metric-value">${new Date(f.DataReuniao).toLocaleDateString('pt-BR')}</div></div>
                    </div>
                    ${f.TicketMedio ? `<div class="metric-row"><div class="metric-item"><div class="metric-label">Ticket</div><div class="metric-value">R$ ${f.TicketMedio.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div></div></div>` : ''}
                </div>`;
            }).join('');
        }

        function updateKPIs() {
            const dados = filtrarDados(allData);
            const total = dados.length;
            const fechados = dados.filter(r => r.fields.StatusAvanco === 'Avançou').length;
            const pendentes = total - fechados - dados.filter(r => r.fields.StatusAvanco === 'Não Avançou').length;
            const taxa = total > 0 ? (fechados / total * 100).toFixed(1) : 0;
            document.getElementById('total-agendamentos').textContent = total;
            document.getElementById('total-avancou').textContent = fechados;
            document.getElementById('total-pendentes').textContent = pendentes;
            document.getElementById('taxa-conversao').textContent = taxa + '%';
        }

        function openModal(id) {
            currentRecordId = id;
            const r = allData.find(x => x.id === id);
            const f = r.fields;
            document.getElementById('modal-title').textContent = f.Empresa;
            const fields = [
                { label: 'Responsável', value: f.Responsavel, key: 'Responsavel' },
                { label: 'Data Reunião', value: new Date(f.DataReuniao).toLocaleDateString('pt-BR'), key: 'DataReuniao' },
                { label: 'Status Negociação', value: f.statusNegociacao || 'Pendente', key: 'statusNegociacao', editable: true },
                { label: 'Status Avanço', value: f.StatusAvanco || 'Pendente', key: 'StatusAvanco', editable: true },
                { label: 'Ticket Médio', value: f.TicketMedio ? `R$ ${f.TicketMedio.toFixed(2)}` : 'N/A', key: 'TicketMedio', editable: true },
                { label: 'Nº Lojas', value: f.NumeroLojas || 'N/A', key: 'NumeroLojas', editable: true },
                { label: 'Nº Funcionários', value: f.NumeroFuncionarios || 'N/A', key: 'NumeroFuncionarios', editable: true },
                { label: 'Segmento', value: f.Segmento || 'N/A', key: 'Segmento', editable: true },
                { label: 'Local', value: f.LocalEvento || 'N/A', key: 'LocalEvento', editable: true }
            ];
            document.getElementById('modal-content').innerHTML = fields.map(field => `
                <div class="field-group">
                    <label class="field-label">${field.label}</label>
                    <div class="field-value" ${field.editable ? `onclick="editField('${field.key}', '${field.value}')"` : ''}>${field.value}</div>
                </div>
            `).join('');
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }

        async function editField(key, value) {
            let inputType = 'text', options = {};
            if (key === 'statusNegociacao') {
                inputType = 'select';
                options = {
                    'Reunião Agendada': 'Reunião Agendada',
                    'Reunião Realizada': 'Reunião Realizada',
                    'Proposta Enviada': 'Proposta Enviada',
                    'Contrato Enviado': 'Contrato Enviado',
                    'Contrato Assinado': 'Contrato Assinado'
                };
            } else if (key === 'StatusAvanco') {
                inputType = 'select';
                options = { 'Pendente': 'Pendente', 'Avançou': 'Avançou', 'Não Avançou': 'Não Avançou' };
            }
            const { value: novo } = await Swal.fire({ title: `Editar ${key}`, input: inputType, inputOptions: options, inputValue: value.replace(/R\$ |\N\/A/g, ''), showCancelButton: true });
            if (novo !== undefined) {
                let processed = novo;
                if (['TicketMedio'].includes(key)) processed = parseFloat(novo);
                if (['NumeroLojas','NumeroFuncionarios'].includes(key)) processed = parseInt(novo);
                if (key === 'statusNegociacao' && novo === 'Contrato Assinado') {
                    await fetch(API_URL, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recordId: currentRecordId, fields: { 'StatusAvanco': 'Avançou' } }) });
                }
                await fetch(API_URL, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recordId: currentRecordId, fields: { [key]: processed } }) });
                Swal.fire('Sucesso!', 'Atualizado', 'success');
                loadData(); closeModal();
            }
        }

        async function exportReport() {
            const btn = document.getElementById('export-btn'); 
            btn.disabled = true; btn.textContent = 'Gerando...';
            try {
                const dados = filtrarDados(allData);
                const etapas = ['Reunião Agendada', 'Reunião Realizada', 'Proposta Enviada', 'Contrato Enviado', 'Contrato Assinado'];
                
                const contagem = etapas.map(e => dados.filter(r => r.fields.statusNegociacao === e).length);
                const queda = etapas.map(e => dados.filter(r => r.fields.statusNegociacao === e && r.fields.StatusAvanco === 'Não Avançou').length);

                const porRespEtapa = {};
                dados.forEach(r => {
                    const resp = r.fields.Responsavel || 'Sem responsável';
                    const etapa = r.fields.statusNegociacao;
                    if (!porRespEtapa[resp]) porRespEtapa[resp] = {};
                    porRespEtapa[resp][etapa] = (porRespEtapa[resp][etapa] || 0) + 1;
                });

                const listaEmpresas = dados.map(r => {
                    const f = r.fields;
                    return {
                        empresa: f.Empresa,
                        responsavel: f.Responsavel,
                        status: f.statusNegociacao || '-',
                        data: new Date(f.DataReuniao).toLocaleDateString('pt-BR'),
                        ticket: f.TicketMedio ? `R$ ${f.TicketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : '-'
                    };
                });

                const dataAtual = new Date().toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'short' });

                const container = document.createElement('div');
                container.className = 'report-container';
                document.body.appendChild(container);

                container.innerHTML = `
                    <div class="report-header">
                        <div class="report-title">Relatório Completo de Agendamentos</div>
                        <div style="opacity:0.9;margin-top:0.5rem;">${dataAtual}</div>
                    </div>

                    <div class="report-section">
                        <h3>Funil de Negociação (Total)</h3>
                        <div class="report-grid">
                            ${etapas.map((e,i) => `
                                <div class="report-kpi">
                                    <div class="report-kpi-value">${contagem[i]}</div>
                                    <div class="report-kpi-label">${e}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>Queda por Etapa</h3>
                        <table class="report-table">
                            <thead><tr><th>Etapa</th><th>Total</th><th>Não Avançou</th><th>% Queda</th></tr></thead>
                            <tbody>
                                ${etapas.map((e,i) => {
                                    const t = contagem[i], q = queda[i], taxa = t > 0 ? (q/t*100).toFixed(1) : 0;
                                    return `<tr>
                                        <td><strong>${e}</strong></td>
                                        <td>${t}</td>
                                        <td style="color:#ef4444;">${q}</td>
                                        <td>${taxa}%</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3>Funil por Responsável</h3>
                        <table class="report-table" style="font-size:0.9rem;">
                            <thead>
                                <tr>
                                    <th>Responsável</th>
                                    ${etapas.map(e => `<th>${e.split(' ')[0]}<br><small>${e.split(' ').slice(1).join(' ')}</small></th>`).join('')}
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(porRespEtapa).map(([resp, etapasMap]) => {
                                    const total = Object.values(etapasMap).reduce((a,b) => a+b, 0);
                                    return `<tr>
                                        <td><strong>${resp}</strong></td>
                                        ${etapas.map(e => `<td>${etapasMap[e] || 0}</td>`).join('')}
                                        <td><strong>${total}</strong></td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3>Lista de Empresas</h3>
                        <table class="report-table" style="font-size:0.85rem;">
                            <thead><tr><th>Empresa</th><th>Responsável</th><th>Status</th><th>Data</th><th>Ticket</th></tr></thead>
                            <tbody>
                                ${listaEmpresas.length ? listaEmpresas.map(e => `
                                    <tr>
                                        <td>${e.empresa}</td>
                                        <td>${e.responsavel}</td>
                                        <td>${e.status}</td>
                                        <td>${e.data}</td>
                                        <td>${e.ticket}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" style="text-align:center;color:#6b7280;">Nenhum registro</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-footer">Gerado em ${dataAtual}</div>
                `;

                await new Promise(r => setTimeout(r, 600));
                const canvas = await html2canvas(container, { scale: 2, useCORS: true, backgroundColor: '#fff' });
                document.body.removeChild(container);

                const link = document.createElement('a');
                link.download = `relatorio_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();

                Swal.fire('Sucesso!', 'Relatório exportado!', 'success');
            } catch (err) {
                console.error(err);
                Swal.fire('Erro', 'Falha ao gerar', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Exportar Relatório PNG';
            }
        }

        function getDateRange(t) {
            const hoje = new Date(), inicio = new Date(), fim = new Date();
            if (t === 'hoje') { inicio.setHours(0,0,0,0); fim.setHours(23,59,59,999); }
            else if (t === 'semana') { const d = hoje.getDay(); const diff = hoje.getDate() - d + (d===0?-6:1); inicio.setDate(diff); inicio.setHours(0,0,0,0); fim.setDate(diff+6); fim.setHours(23,59,59,999); }
            else if (t === 'mes') { inicio.setDate(1); inicio.setHours(0,0,0,0); fim.setMonth(fim.getMonth()+1); fim.setDate(0); fim.setHours(23,59,59,999); }
            else return { inicio: null, fim: null };
            return { inicio: inicio.toISOString().split('T')[0], fim: fim.toISOString().split('T')[0] };
        }

        function aplicarFiltro() {
            filtroAtual = document.getElementById('filtro-periodo').value;
            filtroResp = document.getElementById('filtro-responsavel').value;
            renderResponsaveis();
            renderCards();
            updateKPIs();
        }

        function filtrarDados(d) {
            let dados = d;
            if (filtroAtual !== 'todos') {
                const { inicio, fim } = getDateRange(filtroAtual);
                dados = dados.filter(r => r.fields.DataCriacao >= inicio && r.fields.DataCriacao <= fim);
            }
            if (filtroResp) {
                dados = dados.filter(r => r.fields.Responsavel === filtroResp);
            }
            return dados;
        }

        document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target.id === 'modal-overlay') closeModal(); });
        loadData();
    </script>
</body>
</html>