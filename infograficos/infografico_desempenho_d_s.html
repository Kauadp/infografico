<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Desempenho de Vendas - Exagerado</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="shortcut icon" href="../imagens/favicon.ico" type="image/x-icon">

    <style>
        /* Paleta de cores do e-commerce */
        :root {
            --color-primary-green: #57da1c;
            --color-secondary-purple: #E54E88;
            --color-dark-blue: #222222;
            --color-accent-orange: #f95b3c;
            --color-accent-teal: #00BFB2;
            --color-accent-yellow: #FDBB2D;
            --color-light-gray-bg: #F0F0F0;
            --color-white: #FFFFFF;
            --color-text-dark: #4A5568;
            --color-light-hover: #EFEFEF;
        }
        
        body {
            font-family: 'Nunito', sans-serif; 
            background-color: var(--color-light-gray-bg); 
            color: var(--color-text-dark);
        }
        
        .kpi-card {
            background-color: var(--color-white); 
            border-radius: 1rem;
            padding: 2rem;
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            border-left: 6px solid var(--color-secondary-purple);
        }
        .kpi-card:hover { 
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }
        .kpi-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--color-accent-orange);
            margin-bottom: 0.5rem;
        }
        .kpi-label {
            font-weight: 700;
            color: var(--color-text-dark);
            font-size: 1.2rem;
        }
        
        /* Estilos dos campos de formulário - COM A BORDA ADICIONADA */
        .form-input, .form-select { 
            background-color: var(--color-white); 
            border: 1px solid #d1d5db; /* Borda cinza suave */
            border-radius: 0.75rem;
            color: var(--color-text-dark); 
            padding: 0.85rem 1.25rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-size: 1rem;
        }
        .form-input::placeholder {
            color: #A0AEC0;
        }
        .form-input:focus, .form-select:focus { 
            border-color: var(--color-secondary-purple); /* Borda rosa ao focar */
            box-shadow: 0 0 0 2px rgba(229, 78, 136, 0.25);
            outline: none; 
        }
        
        .btn-primary {
            background: var(--color-secondary-purple);
            color: var(--color-white);
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn-primary:hover {
            background: #ab4477;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(229, 78, 136, 0.3);
        }
        
        .btn-warning {
            background: var(--color-accent-orange);
            color: var(--color-white);
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn-warning:hover {
            background: #e6680a;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(249, 91, 60, 0.3);
        }
        
        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--color-dark-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .agendamento-item {
            background: #f8fafc;
            border: 1px solid var(--color-light-gray);
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--color-secondary-purple);
            color: var(--color-white);
            padding: 0.75rem;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            background: var(--color-white);
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .metric-positive {
            color: var(--color-primary-green);
            font-weight: 600;
        }
        
        .metric-negative {
            color: #ef4444;
            font-weight: 600;
        }
        
        .metric-warning {
            color: var(--color-accent-orange);
            font-weight: 600;
        }

        /* Adicione este CSS no seu bloco <style> no <head> */
        .chart-carousel {
            position: relative;
            max-width: 800px;
            margin: auto;
            padding: 0 40px;
        }

        .slick-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            width: 40px !important;
            height: 40px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.85); /* Fundo branco semi-transparente */
            border: 1px solid var(--color-secondary-purple); /* Borda da cor da marca */
            border-radius: 50% !important; /* Forçando o formato de círculo */
            cursor: pointer;
            color: var(--color-secondary-purple) !important; /* Forçando a cor do ícone */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Sombra mais suave */
            transition: all 0.3s ease;
        }

        .slick-arrow:hover {
            background: rgba(255, 255, 255, 1); /* Fundo opaco ao passar o mouse */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .slick-arrow svg {
            width: 20px !important; /* Tamanho da seta dentro do botão */
            height: 20px !important;
            fill: currentColor;
        }

        .slick-prev {
            left: -20px;
        }

        .slick-next {
            right: -20px;
        }

        /* Oculta as bolinhas de navegação */
        .slick-dots {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <script>
  // O token do usuário logado
  const token = localStorage.getItem("token");

  // Se não houver token, redireciona imediatamente
  if (!token) {
    window.location.href = "login.html";
  }

  // Função para verificar se o token é válido
  async function checkAuth() {
    try {
      const response = await fetch("https://api-login-zmcb.onrender.com/dados-protegidos", {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });
      
      // Se a resposta não for OK (por exemplo, 401), redireciona
      if (!response.ok) {
        throw new Error("Token inválido ou expirado.");
      }
      
      console.log("Token válido. O usuário pode continuar.");
      // Aqui você poderia carregar dados ou exibir o conteúdo
      // document.body.style.display = 'block'; // Se o body estiver hidden inicialmente
    } catch (error) {
      console.error("Erro de autenticação:", error);
      localStorage.removeItem("token"); // Limpa o token inválido
      window.location.href = "login.html"; // Redireciona para o login
    }
  }
  
  // Executa a verificação
  checkAuth();
</script>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-3xl font-extrabold text-[var(--color-accent-orange)]">Dashboard de Desempenho de Vendas</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">Configure os agendamentos da equipe e visualize o desempenho diário e semanal em tempo real.</p>
            <div class="mt-4">
                <a href="index.html" class="btn-warning">⬅ Voltar à Página Inicial</a>
            </div>
        </header>

        <main>
            <!-- Seção de Entrada de Dados -->
            <section id="input-section" class="mb-16 kpi-card">
                <h2 class="text-2xl font-extrabold text-[var(--color-accent-orange)]">Configuração de Agendamentos</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Formulário de Entrada -->
                    <div>
                        <h3 class="text-2xl font-extrabold text-[var(--color-accent-orange)]">Adicionar Agendamento</h3>
                        <form id="agendamentoForm" class="space-y-4">
                            <div>
                                <label class="block font-semibold mb-2 text-[var(--color-text-dark)]">Responsável:</label>
                                <select id="responsavel" class="form-select w-full p-3">
                                    <option value="">Selecione o responsável</option>
                                    <option value="Emilin">Emilin</option>
                                    <option value="Stela">Stela</option>
                                    <option value="Bruna Azevedo">Bruna Azevedo</option>
                                    <option value="Gabriela Moreira">Gabriela Moreira</option>
                                    <option value="Matheus">Matheus</option>
                                    <option value="Priscila Prado">Priscila Prado</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block font-semibold mb-2 text-[var(--color-text-dark)]">Nome da Empresa:</label>
                                <input type="text" id="empresa" placeholder="Digite o nome da empresa" 
                                       class="form-select w-full p-3">
                            </div>
                            
                            <div>
                                <label class="block font-semibold mb-2 text-[var(--color-text-dark)]">Data da Reunião:</label>
                                <input type="date" id="dataReuniao" 
                                       class="form-select w-full p-3">
                            </div>
                            
                            <button type="submit" class="btn-primary w-full">Adicionar Agendamento</button>
                        </form>
                        
                    </div>
                    
                    <!-- Lista de Agendamentos -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-extrabold text-[var(--color-accent-orange)]">Lista de Agendamentos</h3>
                            <button onclick="limparAgendamentos()" class="btn-warning">Limpar Todos</button>
                        </div>
                        <div id="listaAgendamentos" class="space-y-4 max-h-80 overflow-y-auto">
                            <p class="text-gray-500 text-center py-8">Nenhum agendamento adicionado ainda.</p>
                        </div>
                        
                        <!-- Resumo por Responsável -->
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="text-lg font-semibold mb-3 text-[var(--color-dark-blue)]">Resumo por Responsável</h4>
                            <div id="resumoResponsaveis" class="text-sm space-y-1">
                                <p class="text-gray-500">Nenhum agendamento para resumir.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botões de Ação -->
                <div class="mt-8 text-center">
                    <div class="flex flex-wrap justify-center gap-4">
                        <button onclick="buscarDesempenhoDiario()" class="btn-warning flex items-center gap-2" id="btnDiario">
                            <span>Buscar Desempenho Diário</span>
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>Carregando...</span>
                            </div>
                        </button>
                        
                        <button onclick="buscarDesempenhoSemanal()" class="btn-warning flex items-center gap-2" id="btnSemanal">
                            <span>Buscar Desempenho Semanal</span>
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>Carregando...</span>
                            </div>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Seção do Quadro de Agendamentos da Semana -->
            <section id="quadro-section" class="mb-16 kpi-card">
                <h2 class="text-2xl font-extrabold text-[var(--color-accent-orange)]">Quadro de Agendamentos da Semana</h2>
                <p class="text-center text-gray-600 mb-8">Acompanhe visualmente os agendamentos de cada responsável já configurados</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Lista dos Agendamentos Atuais (Reutilizada) -->
                    <div class="kpi-card">
                        <h3 class="text-2xl font-semibold mb-4 text-[var(--color-accent-orange)] flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            Agendamentos Configurados
                        </h3>
                        
                        <div id="quadroListaAgendamentos" class="space-y-2 max-h-80 overflow-y-auto">
                            <p class="text-gray-500 text-center py-8">Configure agendamentos na seção acima para visualizá-los aqui.</p>
                        </div>
                        
                        <!-- Resumo por Responsável para o Quadro -->
                        <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                            <h4 class="text-lg font-semibold mb-3 text-[var(--color-accent-orange)]">Resumo para o Quadro</h4>
                            <div id="resumoQuadroResponsaveis" class="text-sm space-y-1">
                                <p class="text-gray-500">Nenhum agendamento para exibir no quadro.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Controles do Quadro -->
                    <div class="kpi-card">
                        <h3 class="text-2xl font-extrabold mb-4 text-[var(--color-secondary-purple)] flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Controles do Quadro Visual
                        </h3>
                        
                        <div class="space-y-4">
                            <button onclick="gerarQuadroSemana()" class="btn-primary w-full flex items-center justify-center gap-2" id="btnGerarQuadro">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                                <span>Gerar Quadro da Semana</span>
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span>Processando...</span>
                                </div>
                            </button>
                            
                            <button onclick="carregarQuadroExistente()" class="btn-primary w-full flex items-center justify-center gap-2" id="btnCarregarQuadro">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span>Consultar Quadro Existente</span>
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span>Carregando...</span>
                                </div>
                            </button>
                            
                            <div class="text-center">
                                <p class="text-sm text-gray-600 mb-2">Período do quadro:</p>
                                <p id="periodoQuadro" class="font-semibold text-gray-800">-</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                            <h4 class="text-xl font-bold mb-2 text-[var(--color-text-dark)] flex items-center gap-2">
                                <span class="text-[var(--color-accent-orange)] text-lg">⭐</span>
                                Sobre o Quadro Visual
                            </h4>
                            <div class="text-sm text-gray-600 space-y-2">
                                <p><strong>Gerar Quadro:</strong> Usa seus agendamentos configurados para criar o quadro visual</p>
                                <p><strong>Legenda:</strong> Cada <span class = "text-[var(--color-accent-orange)]">⭐</span> representa um agendamento realizado</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quadro Visual de Agendamentos -->
            <section id="quadro-visual-section" class="mb-16 kpi-card" style="display: none;">
                <h2 class="text-lg font-semibold mb-3 text-[var(--color-accent-orange)]">Quadro da Semana - Agendamentos por Responsável</h2>
                
                <!-- Resumo Geral -->
                <div class="mb-8 text-center">
                    <div class="inline-flex items-center gap-6 bg-white rounded-lg p-6 shadow-md">
                        <div class="text-center">
                            <p class="text-3xl font-extrabold text-[var(--color-secondary-purple)]" id="totalAgendamentosQuadro">0</p>
                            <p class="text-sm text-gray-700">Total de Agendamentos</p>
                        </div>
                        <div class="w-px h-12 bg-gray-300"></div>
                        <div class="text-center">
                            <p class="text-3xl font-extrabold text-[var(--color-accent-orange)]" id="totalResponsaveisAtivos">0</p>
                            <p class="text-sm text-gray-700">Responsáveis Ativos</p>
                        </div>
                        <div class="w-px h-12 bg-gray-300"></div>
                        <div class="text-center">
                            <p class="text-xl font-bold text-[var(--color-text-dark)]" id="periodoQuadroAtual">-</p>
                            <p class="text-sm text-gray-700">Período</p>
                        </div>
                    </div>
                </div>
                
                <!-- Grid do Quadro de Responsáveis -->
                <div id="quadroGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards dos responsáveis serão inseridos aqui dinamicamente -->
                </div>
                
                <!-- Lista Detalhada de Empresas -->
                <div id="listaEmpresas" class="mt-12" style="display: none;">
                    <h3 class="text-2xl font-extrabold mb-6 text-[var(--color-secondary-purple)] flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        Lista Detalhada de Empresas Agendadas
                    </h3>
                    <div id="empresasDetalhadas" class="space-y-4">
                        <!-- Detalhes das empresas serão inseridos aqui -->
                    </div>
                </div>
            </section>

            <!-- Seção de Consulta Rápida (Endpoints GET) -->
            <section id="quick-query-section" class="mb-16 kpi-card">
                <h2 class="text-3xl font-semibold mb-3 text-[var(--color-accent-orange)]">Consulta Rápida de Desempenho</h2>
                <p class="text-center text-gray-600 mb-8">Consulte os dados atuais sem necessidade de configurar agendamentos</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Card Desempenho Diário -->
                    <div class="kpi-card">
                        <div class="flex items-center mb-4">
                            <div class="bg-[var(--color-secondary-purple)] text-white rounded-full w-12 h-12 flex items-center justify-center mr-4">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-extrabold text-[var(--color-accent-orange)]">Desempenho do Dia</h3>
                                <p class="text-gray-600 text-sm">Consulta dados do dia atual</p>
                            </div>
                        </div>
                        
                        <p class="text-gray-700 mb-6">Visualize o desempenho da equipe para o dia de hoje, incluindo ligações, agendamentos e métricas de conversão.</p>
                        
                        <button onclick="consultarDesempenhoDiario()" class="btn-warning w-full flex items-center justify-center gap-2" id="btnConsultaDiario">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span>Consultar Hoje</span>
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>Carregando...</span>
                            </div>
                        </button>
                        
                        <div class="mt-4 text-sm text-gray-600 bg-white rounded p-3">
                            <p class="font-medium mb-1">Data da consulta:</p>
                            <p id="dataConsultaDiario"></p>
                        </div>
                    </div>
                    
                    <!-- Card Desempenho Semanal -->
                    <div class="kpi-card">
                        <div class="flex items-center mb-4">
                            <div class="bg-[var(--color-secondary-purple)] text-white rounded-full w-12 h-12 flex items-center justify-center mr-4">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-extrabold text-[var(--color-accent-orange)]">Desempenho da Semana</h3>
                                <p class="text-gray-600 text-sm">Consulta dados da semana atual</p>
                            </div>
                        </div>
                        
                        <p class="text-gray-700 mb-6">Acompanhe o progresso semanal da equipe desde a segunda-feira, com métricas consolidadas e comparativas.</p>
                        
                        <button onclick="consultarDesempenhoSemanal()" class="btn-warning w-full flex items-center justify-center gap-2" id="btnConsultaSemanal">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span>Consultar Semana</span>
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>Carregando...</span>
                            </div>
                        </button>
                        
                        <div class="mt-4 text-sm text-gray-600 bg-white rounded p-3">
                            <p class="font-medium mb-1">Período da consulta:</p>
                            <p id="periodoConsultaSemanal"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Informações sobre os endpoints GET -->
                <div class="mt-8 bg-gray-50 rounded-lg p-6">
                    <h4 class="text-xl font-bold text-[var(--color-secondary-purple)] mb-3 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Sobre a Consulta Rápida
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-[var(--color-dark-blue)]">
                        <div>
                            <p class="font-bold mb-2">Vantagens:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Consulta instantânea dos dados</li>
                                <li>Não precisa configurar agendamentos</li>
                                <li>Dados sempre atualizados</li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-bold mb-2">Dados consultados:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Leitura direta da base</li>
                                <li>Métricas de desempenho</li>
                                <li>Comparativo por responsável</li>
                                <li>Taxa de conversão</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Seção de Resultados -->
            <section id="results-section" class="mb-16 kpi-card" style="display: none;">
                <h2 class="text-3xl font-semibold mb-3 text-[var(--color-accent-orange)]" id="resultsTitle">Resultados do Desempenho</h2>
                
                <!-- KPIs Principais -->
                <div id="kpis-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- KPIs serão inseridos aqui dinamicamente -->
                </div>
                
                <!-- Tabela de Resultados -->
                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr id="tableHeader">
                                <!-- Cabeçalhos serão inseridos dinamicamente -->
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Dados serão inseridos dinamicamente -->
                        </tbody>
                    </table>
                </div>
             
                <!-- Gráficos -->
                <div id="charts-container" class="mt-12 chart-carousel" style="display:none;">
                    <div>
                        <h3 class="text-2xl font-semibold mb-3 text-[var(--color-accent-orange)]">Desempenho Diário</h3>
                        <canvas id="graficoDiario"></canvas>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold mb-3 text-[var(--color-accent-orange)]">Agendamentos Semanais</h3>
                        <canvas id="graficoSemanal"></canvas>
                    </div>
                </div>

                <!-- Informações Adicionais -->
                <div id="additionalInfo" class="mt-8 p-4 bg-gray-50 rounded-lg">
                    <!-- Informações adicionais serão inseridas aqui -->
                </div>
            </section>
            

            <!-- Seção de Erros -->
            <section id="error-section" class="mb-16 kpi-card" style="display: none;">
                <h3 class="text-xl font-semibold text-red-800 mb-4">Erro na Requisição</h3>
                <div id="errorMessage" class="text-red-700"></div>
                <div class="mt-4">
                    <h4 class="font-semibold text-red-800 mb-2">Possíveis soluções:</h4>
                    <ul class="list-disc list-inside text-red-700 space-y-1">
                        <li>Verifique se a URL da API está correta</li>
                        <li>Certifique-se de que a API está rodando</li>
                        <li>Verifique se há agendamentos configurados</li>
                        <li>Consulte o console do navegador para mais detalhes</li>
                    </ul>
                </div>
            </section>
        </main>

        <footer class="text-center mt-16 text-gray-500 text-sm space-y-4">
            <div class="mt-4">
                <a href="../index.html" class="btn-warning">⬅ Voltar à Página Inicial</a>
            </div>
            <div>
                <p>&copy; 2025 Dashboard de Desempenho de Vendas.</p>
            </div>
        </footer>
    </div>

    <script>
        let agendamentos = [];
        
        // Configurar data padrão para hoje
        document.getElementById('dataReuniao').valueAsDate = new Date();
        
        // Submissão do formulário
        document.getElementById('agendamentoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const responsavel = document.getElementById('responsavel').value;
            const empresa = document.getElementById('empresa').value;
            const dataReuniao = document.getElementById('dataReuniao').value;
            
            if (!responsavel || !empresa || !dataReuniao) {
                // Exibe o pop-up de erro
                Swal.fire({
                icon: 'error',
                title: 'Erro!',
                text: 'Por favor, preencha todos os campos.'
                });
                return;
            }
            
            // Adicionar à lista
            agendamentos.push({
                responsavel,
                empresa,
                dataReuniao
            });
            
            // Limpar formulário
            document.getElementById('empresa').value = '';
            
            // Atualizar interface
            atualizarListaAgendamentos();
            atualizarResumoResponsaveis();
        });
        
        function atualizarListaAgendamentos() {
            const container = document.getElementById('listaAgendamentos');
            
            if (agendamentos.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum agendamento adicionado ainda.</p>';
                return;
            }
            
            container.innerHTML = agendamentos.map((agendamento, index) => `
                <div class="agendamento-item">
                    <div>
                        <div class="font-semibold text-gray-900">${agendamento.empresa}</div>
                        <div class="text-sm text-gray-600">${agendamento.responsavel} • ${new Date(agendamento.dataReuniao + 'T00:00:00').toLocaleDateString('pt-BR')}</div>
                    </div>
                    <button onclick="removerAgendamento(${index})" class="text-red-500 hover:text-red-700 font-bold text-xl">×</button>
                </div>
            `).join('');
        }
        
        function atualizarResumoResponsaveis() {
            const resumo = {};
            
            agendamentos.forEach(agendamento => {
                resumo[agendamento.responsavel] = (resumo[agendamento.responsavel] || 0) + 1;
            });
            
            const container = document.getElementById('resumoResponsaveis');
            
            if (Object.keys(resumo).length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhum agendamento para resumir.</p>';
                return;
            }
            
            container.innerHTML = Object.entries(resumo)
                .map(([responsavel, count]) => 
                    `<div class="flex justify-between"><span>${responsavel}:</span><span class="font-semibold">${count} agendamento(s)</span></div>`
                ).join('');
        }
        
        function removerAgendamento(index) {
            agendamentos.splice(index, 1);
            atualizarListaAgendamentos();
            atualizarResumoResponsaveis();
        }
        
        function limparAgendamentos() {
            if (agendamentos.length > 0) {
                Swal.fire({
                    title: 'Tem certeza?',
                    text: 'Você não poderá reverter esta ação!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim, limpar!',
                    cancelButtonText: 'Não, cancelar'
                }).then((result) => {
                    // Ação a ser executada se o usuário confirmar
                    if (result.isConfirmed) {
                        agendamentos = [];
                        atualizarListaAgendamentos();
                        atualizarResumoResponsaveis();
                        
                        Swal.fire(
                            'Limpado!',
                            'Todos os agendamentos foram removidos.',
                            'success'
                        );
                    }
                });
            }
        }
          
        
        function prepararDadosParaAPI() {
            const dadosAPI = {};
            
            agendamentos.forEach(agendamento => {
                dadosAPI[agendamento.responsavel] = (dadosAPI[agendamento.responsavel] || 0) + 1;
            });
            return {agendamentos: dadosAPI}; // ✅ Retornar no formato correto
        }
        
        async function buscarDesempenhoDiario() {
            if (agendamentos.length === 0) {
                exibirErro('Por favor, adicione pelo menos um agendamento para dar continuidade.');
                return;
            }
            await fazerRequisicaoAPI('/desempenho-diario', 'btnDiario', 'Desempenho Diário');
        }
        
        async function buscarDesempenhoSemanal() {
            if (agendamentos.length === 0) {
                exibirErro('Por favor, adicione pelo menos um agendamento para dar continuidade.');
                return;
            }
            await fazerRequisicaoAPI('/desempenho-semanal', 'btnSemanal', 'Desempenho Semanal');
        }
        
        async function fazerRequisicaoAPI(endpoint, buttonId, titulo) {
            const btn = document.getElementById(buttonId);
            const loading = btn.querySelector('.loading');
            const span = btn.querySelector('span');

            // Mostrar loading
            span.style.display = 'none';
            loading.style.display = 'flex';
            btn.disabled = true;

            // Esconder seções
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'none';

            try {
                const apiUrl = "https://api-desempenho.onrender.com";
                const dadosAPI = prepararDadosParaAPI();

                console.log('Enviando dados para API:', dadosAPI);

                const response = await fetch(`${apiUrl}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosAPI)
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Resposta da API:', data);

                if (data.erro) {
                    throw new Error(data.erro);
                }

                exibirResultados(data, titulo);

            } catch (error) {
                console.error('Erro na requisição:', error);
                exibirErro(error.message);
            } finally {
                // Esconder loading
                span.style.display = 'inline';
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }
        
        function exibirResultados(data, titulo) {
            // Verifica se 'data' e 'data.dados' existem e se 'data.dados' é um array.
            if (!data || !Array.isArray(data.dados)) {
                exibirErro('A resposta da API está no formato incorreto. Favor verificar o serviço.');
                return;
            }

            // Acessa o array de dados para a verificação inicial
            const dadosParaTabela = data.dados;

            // Condição de validação:
            // 1. O array de dados está vazio OU
            // 2. O total de ligações, agendamentos e ligações relevantes é zero
            const totalLigacoes = dadosParaTabela.reduce((sum, item) => sum + (item.ligacoes_totais || 0), 0);
            const totalRelevantes = dadosParaTabela.reduce((sum, item) => sum + (item.ligacoes_relevantes || 0), 0);
            
            if (dadosParaTabela.length === 0 || (totalLigacoes === 0 && totalRelevantes === 0)) {
                Swal.fire({
                    icon: 'info',
                    title: 'Nenhuma ligação hoje',
                    text: 'Não houveram ligações hoje'
                });
                return;
            }

            // Criar KPIs
            criarKPIs(dadosParaTabela);

            // Criar tabela
            criarTabela(dadosParaTabela);

            // Criar gráficos
            renderizarGraficos(dadosParaTabela, titulo);

            // Mostrar seção de resultados
            document.getElementById('results-section').style.display = 'block';

            // Scroll para resultados
            document.getElementById('results-section').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
        
        function criarKPIs(dados) {
            const container = document.getElementById('kpis-container');
            
            // Calcular totais
            const totalAgendamentos = dados.reduce((sum, item) => sum + (item.agendamento || 0), 0);
            const totalLigacoes = dados.reduce((sum, item) => sum + (item.ligacoes_totais || 0), 0);
            const totalRelevantes = dados.reduce((sum, item) => sum + (item.ligacoes_relevantes || 0), 0);
            
            const taxaRelevancia = totalLigacoes > 0 ? ((totalRelevantes / totalLigacoes) * 100).toFixed(1) : 0;
            const taxaConversao = totalRelevantes > 0 ? ((totalAgendamentos / totalRelevantes) * 100).toFixed(1) : 0;
            
            container.innerHTML = `
                <div class="kpi-card border-l-4 border-[var(--color-accent-orange)]">
                    <p class="kpi-value text-[var(--color-accent-orange)]">${totalAgendamentos}</p>
                    <p class="kpi-label">Total de Agendamentos</p>
                    <p class="text-sm text-gray-500 mt-2">Soma de todos os agendamentos da equipe</p>
                </div>
                <div class="kpi-card border-l-4 border-[var(--color-accent-teal)]">
                    <p class="kpi-value text-[var(--color-accent-teal)]">${totalLigacoes}</p>
                    <p class="kpi-label">Total de Ligações</p>
                    <p class="text-sm text-gray-500 mt-2">${totalRelevantes} ligações relevantes (${taxaRelevancia}%)</p>
                </div>
                <div class="kpi-card border-l-4 border-[var(--color-accent-yellow)]">
                    <p class="kpi-value text-[var(--color-accent-yellow)]">${taxaConversao}%</p>
                    <p class="kpi-label">Taxa de Conversão</p>
                    <p class="text-sm text-gray-500 mt-2">Ligações relevantes para agendamentos</p>
                </div>
            `;
        }
        
        function criarTabela(dados) {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            if (dados.length === 0) return;
            
            // Obter colunas do primeiro item
            const colunas = Object.keys(dados[0]);
            
            // Criar cabeçalho
            tableHeader.innerHTML = colunas.map(coluna => 
                `<th>${formatarNomeColuna(coluna)}</th>`
            ).join('');
            
            // Criar linhas
            tableBody.innerHTML = dados.map(item => 
                `<tr>
                    ${colunas.map(coluna => 
                        `<td>${formatarValorColuna(coluna, item[coluna])}</td>`
                    ).join('')}
                </tr>`
            ).join('');
        }
        
        function formatarNomeColuna(nome) {
            const mapeamento = {
                'responsavel': 'Responsável',
                'ligacoes_totais': 'Ligações Totais',
                'ligacoes_relevantes': 'Ligações Relevantes',
                'agendamento': 'Agendamentos',
                'meta_ligacoes': 'Meta Ligações',
                'meta_ligacoes_relevantes': 'Meta Ligações Relevantes',
                'meta_agendamento': 'Meta Agendamentos',
                'atingimento_ligacoes': 'Atingimento Ligações',
                'atingimento_ligacoes_relevantes': 'Atingimento Ligações Relevantes',
                'atingimento_agendamento': 'Atingimento Agendamentos',
                'ligacao_x_ligacao_relevante': 'Taxa Ligação → Relevante',
                'ligacao_relevante_x_agendamento': 'Taxa Relevante → Agendamento',
                'ligacao_x_agendamento': 'Taxa Ligação → Agendamento',
                'data': 'Data'
            };
            
            return mapeamento[nome] || nome;
        }
        
        function formatarValorColuna(coluna, valor) {
            if (valor === null || valor === undefined) {
                return '-';
            }
            
            // Formatação de percentuais (atingimentos e taxas)
            if (coluna.includes('atingimento') || coluna.includes('_x_')) {
                const percentual = (valor * 100).toFixed(1);
                let classe = '';
                
                if (coluna.includes('atingimento')) {
                    if (valor >= 1) classe = 'metric-positive';
                    else if (valor >= 0.7) classe = 'metric-warning';
                    else classe = 'metric-negative';
                }
                
                return `<span class="${classe}">${percentual}%</span>`;
            }
            
            // Formatação de data
            if (coluna === 'data') {
                return new Date(valor).toLocaleDateString('pt-BR');
            }
            
            // Números inteiros
            if (typeof valor === 'number' && valor % 1 === 0) {
                return valor.toLocaleString('pt-BR');
            }
            
            // Números decimais
            if (typeof valor === 'number') {
                return valor.toFixed(2);
            }
            
            return valor;
        }
        
        function exibirErro(mensagem) {
            Swal.fire({
                icon: 'error',
                title: 'Erro!',
                text: mensagem
            });
        }
    </script>
    <script>
    
    // Adicione este código para remover as bolinhas
    $(document).ready(function() {
        $('#charts-container .slick-dots').remove();
    });

    // Função para gerar os gráficos
    function renderizarGraficos(dadosResponsavel, titulo) {
        const chartsContainer = document.getElementById("charts-container");
        chartsContainer.style.display = "block";

        const canvasDiario = document.getElementById('graficoDiario');
        const canvasSemanal = document.getElementById('graficoSemanal');
        
        // Destruir carrossel e gráficos existentes
        if ($(chartsContainer).hasClass('slick-initialized')) {
            $(chartsContainer).slick('unslick');
        }
        if (canvasDiario.chart) canvasDiario.chart.destroy();
        if (canvasSemanal.chart) canvasSemanal.chart.destroy();

        // 🔹 Gráfico de Barras: Comparativo por Responsável
        const labelsPorResponsavel = dadosResponsavel.map(item => item.responsavel);
        const agendamentosData = dadosResponsavel.map(item => item.agendamento);
        const ligacoesRelevantesData = dadosResponsavel.map(item => item.ligacoes_relevantes);
        
        const ctxComparativo = canvasDiario.getContext("2d");
        canvasDiario.chart = new Chart(ctxComparativo, {
            type: "bar",
            data: {
                labels: labelsPorResponsavel,
                datasets: [{
                    label: "Agendamentos",
                    data: agendamentosData,
                    backgroundColor: "rgba(249, 91, 60, 0.8)",
                    borderColor: "rgba(249, 91, 60, 1)",
                    borderWidth: 1
                }, {
                    label: "Ligações Relevantes",
                    data: ligacoesRelevantesData,
                    backgroundColor: "rgba(0, 191, 178, 0.8)",
                    borderColor: "rgba(0, 191, 178, 1)",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: `Comparativo de Desempenho - ${titulo}`
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 🔹 Lógica para o Gráfico de Linha (com nova requisição)
        (async () => {
            try {
                // A URL do seu servidor local para o gráfico temporal
                const response = await fetch(`https://api-desempenho.onrender.com/grafico-agendamentos`);
                const data = await response.json();
                const dadosAgendamentosPorDia = data.dados;

                const diasDaSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                const labelsTemporais = dadosAgendamentosPorDia.map(item => {
                    const partesData = item.data.split('-');
                    const dataObj = new Date(partesData[0], partesData[1] - 1, partesData[2]);
                    return diasDaSemana[dataObj.getDay()];
                });
                const dadosAgendamentos = dadosAgendamentosPorDia.map(item => item.total_agendamentos);

                const ctxAgendamentos = canvasSemanal.getContext("2d");
                canvasSemanal.chart = new Chart(ctxAgendamentos, {
                    type: "line",
                    data: {
                        labels: labelsTemporais,
                        datasets: [{
                            label: "Total de Agendamentos por Dia",
                            data: dadosAgendamentos,
                            fill: false,
                            borderColor: "rgb(229, 78, 136)",
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Total de Agendamentos por Dia`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Agendamentos'
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Erro ao buscar dados de agendamentos por dia:", error);
            }

            // Inicializa o carrossel Slick após a criação dos dois gráficos
            $(chartsContainer).slick({
                dots: false, // Desabilitar as bolinhas
                arrows: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                adaptiveHeight: true,
                prevArrow: '<button class="slick-prev slick-arrow"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>',
                nextArrow: '<button class="slick-next slick-arrow"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>'
            });
            
            // Remove as bolinhas definitivamente após a inicialização do Slick.js
            $(chartsContainer).find('.slick-dots').remove();

        })();
    }
</script>

<script>
// Funções para os endpoints GET
function atualizarDatasConsulta() {
    // Atualizar data atual
    const hoje = new Date().toLocaleDateString('pt-BR');
    document.getElementById('dataConsultaDiario').textContent = hoje;
    
    // Calcular início da semana (segunda-feira)
    const agora = new Date();
    const diaSemanaa = agora.getDay();
    const diasAteMongda = diaSemanaa === 0 ? -6 : 1 - diaSemanaa; // Domingo = 0, então -6 dias
    const inicioSemana = new Date(agora);
    inicioSemana.setDate(agora.getDate() + diasAteMongda);
    
    const inicioSemanaStr = inicioSemana.toLocaleDateString('pt-BR');
    document.getElementById('periodoConsultaSemanal').textContent = `Desde ${inicioSemanaStr}`;
}

// Atualizar as datas quando a página carrega
document.addEventListener('DOMContentLoaded', atualizarDatasConsulta);

async function consultarDesempenhoDiario() {
    await fazerRequisicaoGET('/desempenho-diario', 'btnConsultaDiario', 'Consulta Rápida - Desempenho Diário');
}

async function consultarDesempenhoSemanal() {
    await fazerRequisicaoGET('/desempenho-semanal', 'btnConsultaSemanal', 'Consulta Rápida - Desempenho Semanal');
}

async function fazerRequisicaoGET(endpoint, buttonId, titulo) {
    const btn = document.getElementById(buttonId);
    const loading = btn.querySelector('.loading');
    const span = btn.querySelector('span');
    
    // Mostrar loading
    span.style.display = 'none';
    loading.style.display = 'flex';
    btn.disabled = true;
    
    // Esconder seções
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('error-section').style.display = 'none';
    
    try {
        const apiUrl = "https://api-desempenho.onrender.com";
        
        console.log(`Fazendo requisição GET para: ${apiUrl}${endpoint}`);
        
        const response = await fetch(`${apiUrl}${endpoint}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Resposta da API (GET):', data);
        
        // Verificar se há erro na resposta
        if (data.erro) {
            throw new Error(data.erro);
        }
        
        // Verificar se não há dados (usando a estrutura da nova API)
        if (data.message && data.message.includes('Não houveram ligações')) {
            Swal.fire({
            icon: 'info',
            title: 'Nenhuma ligação hoje',
            text: 'Não houveram ligações hoje'
        });
        return;;
            return;
        }
        
        // Se há dados, processar normalmente
        const dadosParaExibir = data;
        exibirResultados(dadosParaExibir, titulo);
        
    } catch (error) {
        console.error('Erro na requisição GET:', error);
        exibirErro(error.message);
    } finally {
        // Esconder loading
        span.style.display = 'inline';
        loading.style.display = 'none';
        btn.disabled = false;
    }
}

function exibirMensagemSemDados(data, titulo) {
    document.getElementById('resultsTitle').textContent = titulo;
    
    // Limpar KPIs e tabela
    document.getElementById('kpis-container').innerHTML = `
        <div class="col-span-full text-center py-8">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                <svg class="w-16 h-16 text-yellow-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">${data.message}</h3>
                <p class="text-yellow-700">Data/Período: ${data.data || data.periodo || 'N/A'}</p>
            </div>
        </div>
    `;
    
    // Limpar tabela
    document.getElementById('tableHeader').innerHTML = '';
    document.getElementById('tableBody').innerHTML = '';
    
    // Esconder gráficos
    document.getElementById('charts-container').style.display = 'none';
    
    // Mostrar seção de resultados
    document.getElementById('results-section').style.display = 'block';
    
    // Scroll para resultados
    document.getElementById('results-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}
</script>

<script>
// Função para sincronizar a lista de agendamentos do quadro com a lista principal
function sincronizarQuadroAgendamentos() {
    const quadroContainer = document.getElementById('quadroListaAgendamentos');
    const resumoContainer = document.getElementById('resumoQuadroResponsaveis');
    
    if (!quadroContainer || !resumoContainer) {
        console.warn('Elementos do quadro não encontrados');
        return;
    }
    
    if (agendamentos.length === 0) {
        quadroContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Configure agendamentos na seção acima para visualizá-los aqui.</p>';
        resumoContainer.innerHTML = '<p class="text-gray-500">Nenhum agendamento para exibir no quadro.</p>';
        return;
    }
    
    // Mostrar lista de agendamentos (mesmo formato da lista principal)
    quadroContainer.innerHTML = agendamentos.map((agendamento, index) => `
        <div class="agendamento-item bg-orange-50 border-orange-200">
            <div>
                <div class="font-semibold text-gray-900">${agendamento.empresa}</div>
                <div class="text-sm text-gray-600">${agendamento.responsavel} • ${new Date(agendamento.dataReuniao + 'T00:00:00').toLocaleDateString('pt-BR')}</div>
            </div>
            <span class="text-yellow-500 text-xl">⭐</span>
        </div>
    `).join('');
    
    // Criar resumo por responsável
    const resumo = {};
    agendamentos.forEach(agendamento => {
        resumo[agendamento.responsavel] = (resumo[agendamento.responsavel] || 0) + 1;
    });
    
    resumoContainer.innerHTML = Object.entries(resumo)
        .map(([responsavel, count]) => 
            `<div class="flex justify-between items-center py-1">
                <span>${responsavel}:</span>
                <span class="font-semibold flex items-center gap-1">
                    ${count} agendamento(s)
                    <span class="text-yellow-500">${'⭐'.repeat(Math.min(count, 5))}${count > 5 ? '+' : ''}</span>
                </span>
            </div>`
        ).join('');
}

// Sobrescrever a função atualizarListaAgendamentos existente para incluir sincronização
function atualizarListaAgendamentos() {
    const container = document.getElementById('listaAgendamentos');
    
    if (agendamentos.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum agendamento adicionado ainda.</p>';
        sincronizarQuadroAgendamentos(); // Sincronizar
        return;
    }
    
    container.innerHTML = agendamentos.map((agendamento, index) => `
        <div class="agendamento-item">
            <div>
                <div class="font-semibold text-gray-900">${agendamento.empresa}</div>
                <div class="text-sm text-gray-600">${agendamento.responsavel} • ${new Date(agendamento.dataReuniao + 'T00:00:00').toLocaleDateString('pt-BR')}</div>
            </div>
            <button onclick="removerAgendamento(${index})" class="text-red-500 hover:text-red-700 font-bold text-xl">×</button>
        </div>
    `).join('');
    
    // Sincronizar com o quadro
    sincronizarQuadroAgendamentos();
}

// Sobrescrever a função atualizarResumoResponsaveis existente para incluir sincronização
function atualizarResumoResponsaveis() {
    const resumo = {};
    
    agendamentos.forEach(agendamento => {
        resumo[agendamento.responsavel] = (resumo[agendamento.responsavel] || 0) + 1;
    });
    
    const container = document.getElementById('resumoResponsaveis');
    
    if (Object.keys(resumo).length === 0) {
        container.innerHTML = '<p class="text-gray-500">Nenhum agendamento para resumir.</p>';
        sincronizarQuadroAgendamentos(); // Sincronizar
        return;
    }
    
    container.innerHTML = Object.entries(resumo)
        .map(([responsavel, count]) => 
            `<div class="flex justify-between"><span>${responsavel}:</span><span class="font-semibold">${count} agendamento(s)</span></div>`
        ).join('');
        
    // Sincronizar com o quadro
    sincronizarQuadroAgendamentos();
}

// Configurar período do quadro quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
    atualizarPeriodoQuadro();
    sincronizarQuadroAgendamentos();
});

function atualizarPeriodoQuadro() {
    const elemento = document.getElementById('periodoQuadro');
    if (!elemento) return;
    
    const agora = new Date();
    const diaSemanaa = agora.getDay();
    const diasAteMongda = diaSemanaa === 0 ? -6 : 1 - diaSemanaa;
    const inicioSemana = new Date(agora);
    inicioSemana.setDate(agora.getDate() + diasAteMongda);
    
    const fimSemana = new Date(inicioSemana);
    fimSemana.setDate(inicioSemana.getDate() + 6);
    
    const inicioSemanaStr = inicioSemana.toLocaleDateString('pt-BR');
    const fimSemanaStr = fimSemana.toLocaleDateString('pt-BR');
    
    elemento.textContent = `${inicioSemanaStr} - ${fimSemanaStr}`;
}

// Função para gerar o quadro da semana enviando agendamentos individualmente
async function gerarQuadroSemana() {
    const btn = document.getElementById('btnGerarQuadro');
    if (!btn) {
        console.error('Botão btnGerarQuadro não encontrado');
        return;
    }
    
    const loading = btn.querySelector('.loading');
    const span = btn.querySelector('span');
    
    if (agendamentos.length === 0) {
        // Previne que a ação padrão do botão (como submissão de formulário) aconteça
            event.preventDefault(); 
        
            // Exibe o pop-up de erro
            Swal.fire({
                icon: 'error',
                title: 'Erro!',
                text: 'Por favor, adicione pelo menos um agendamento antes de gerar o quadro.'
            });
            return;
    }
    
    // Mostrar loading
    if (span) span.style.display = 'none';
    if (loading) loading.style.display = 'flex';
    btn.disabled = true;
    
    try {
        let sucessos = 0;
        let erros = 0;
        let duplicatas = 0;
        
        // Enviar cada agendamento individualmente usando o endpoint que funciona
        for (const agendamento of agendamentos) {
            try {
                const dadosAgendamento = {
                    responsavel: agendamento.responsavel,
                    empresa: agendamento.empresa,
                    data: agendamento.dataReuniao
                };
                
                console.log('Enviando agendamento:', dadosAgendamento);
                
                const response = await fetch(`https://api-desempenho.onrender.com/adicionar-agendamento`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosAgendamento)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Resposta:', data);
                
                if (data.status === 'sucesso') {
                    sucessos++;
                } else if (data.status === 'duplicata') {
                    duplicatas++;
                } else {
                    erros++;
                }
                
            } catch (error) {
                console.error('Erro no agendamento:', error);
                erros++;
            }
        }
        
        // Criar a mensagem
        let mensagem = '';
        let icone = 'info'; // Ícone padrão

        if (sucessos > 0) {
            mensagem += `✓ ${sucessos} agendamentos adicionados.\n`;
        }
        if (duplicatas > 0) {
            mensagem += `⚠ ${duplicatas} duplicatas (já existiam).\n`;
            icone = 'warning';
        }
        if (erros > 0) {
            mensagem += `✗ ${erros} erros.\n`;
            icone = 'error';
        }

        // Exibir o pop-up
        Swal.fire({
        icon: icone,
        title: 'Processamento concluído!',
        text: mensagem
        });
        
        // Carregar o quadro após enviar os dados
        if (sucessos > 0 || duplicatas > 0) {
            setTimeout(() => carregarQuadroExistente(), 1000);
        }
        
    } catch (error) {
        console.error('Erro ao gerar quadro:', error);
        alert('Erro ao gerar quadro: ' + error.message);
    } finally {
        // Esconder loading
        if (span) span.style.display = 'inline';
        if (loading) loading.style.display = 'none';
        btn.disabled = false;
    }
}

// Função para carregar quadro existente da API
async function carregarQuadroExistente() {
    const btn = document.getElementById('btnCarregarQuadro');
    if (!btn) {
        console.error('Botão btnCarregarQuadro não encontrado');
        return;
    }
    
    const loading = btn.querySelector('.loading');
    const span = btn.querySelector('span');
    
    // Mostrar loading
    if (span) span.style.display = 'none';
    if (loading) loading.style.display = 'flex';
    btn.disabled = true;
    
    try {
        console.log('Carregando quadro existente da API...');
        
        const response = await fetch("https://api-desempenho.onrender.com/quadro-semana", {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Dados do quadro existente:', data);
        
        if (data.erro) {
            throw new Error(data.erro);
        }
        
        renderizarQuadroSemana(data);
        
    } catch (error) {
        console.error('Erro ao carregar quadro existente:', error);
        alert('Erro ao carregar quadro existente: ' + error.message);
    } finally {
        // Esconder loading
        if (span) span.style.display = 'inline';
        if (loading) loading.style.display = 'none';
        btn.disabled = false;
    }
}

// Função para renderizar o quadro visual - COM CORREÇÃO DO CONTADOR
function renderizarQuadroSemana(data) {
    const quadroGrid = document.getElementById('quadroGrid');
    const quadroVisualSection = document.getElementById('quadro-visual-section');
    const listaEmpresas = document.getElementById('listaEmpresas');
    
    if (!quadroGrid || !quadroVisualSection) {
        console.error('Elementos do quadro visual não encontrados');
        return;
    }
    
    // Mostrar seção do quadro visual
    quadroVisualSection.style.display = 'block';
    
    // Verificar se há dados
    if (!data.dados || Object.keys(data.dados).length === 0) {
        quadroGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Quadro Vazio</h3>
                <p class="text-gray-500">${data.message || 'Nenhum agendamento encontrado para esta semana'}</p>
                <p class="text-sm text-gray-400 mt-2">${data.periodo || ''}</p>
            </div>
        `;
        
        // Atualizar resumo
        const totalElement = document.getElementById('totalAgendamentosQuadro');
        const responsaveisElement = document.getElementById('totalResponsaveisAtivos');
        const periodoElement = document.getElementById('periodoQuadroAtual');
        
        if (totalElement) totalElement.textContent = '0';
        if (responsaveisElement) responsaveisElement.textContent = '0';
        if (periodoElement) periodoElement.textContent = data.periodo || '-';
        
        // Esconder lista de empresas
        if (listaEmpresas) listaEmpresas.style.display = 'none';
        
        return;
    }
    
    // Calcular totais
    let totalAgendamentos = 0;
    const responsaveis = Object.keys(data.dados);
    
    responsaveis.forEach(resp => {
        totalAgendamentos += data.dados[resp].agendamentos || 0;
    });
    
    // Atualizar resumo
    const totalElement = document.getElementById('totalAgendamentosQuadro');
    const responsaveisElement = document.getElementById('totalResponsaveisAtivos');
    const periodoElement = document.getElementById('periodoQuadroAtual');
    
    if (totalElement) totalElement.textContent = totalAgendamentos;
    if (responsaveisElement) responsaveisElement.textContent = responsaveis.length;
    if (periodoElement) periodoElement.textContent = data.periodo || '-';
    
    
    // Renderizar cards dos responsáveis
    quadroGrid.innerHTML = responsaveis.map(responsavel => {
        const dadosResp = data.dados[responsavel];
        const numAgendamentos = dadosResp.agendamentos || 0;
        const estrelas = '⭐'.repeat(Math.min(numAgendamentos, 10)); // Máximo 10 estrelas para não quebrar o layout
        const estrelasExtra = numAgendamentos > 10 ? `+${numAgendamentos - 10}` : '';
        
        // Preparar dados das empresas de forma segura
        let empresasData = '';
        if (dadosResp.empresas) {
            try {
                empresasData = JSON.stringify(dadosResp.empresas);
            } catch (e) {
                console.warn('Erro ao serializar empresas:', e);
                empresasData = JSON.stringify([]);
            }
        }
        
        // CORREÇÃO: Contar empresas corretamente (array OU string)
        let contadorEmpresas = 0;
        if (dadosResp.empresas) {
            if (Array.isArray(dadosResp.empresas)) {
                contadorEmpresas = dadosResp.empresas.length;
            } else if (typeof dadosResp.empresas === 'string' && dadosResp.empresas.trim() !== '') {
                contadorEmpresas = 1; // Se é string não-vazia, conta como 1
            } else {
                contadorEmpresas = 0;
            }
        }
        
        return `
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-6 border-l-4 border-yellow-400 hover:shadow-lg transition-shadow">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">${responsavel}</h4>
                <div class="text-center mb-4">
                    <div class="text-2xl mb-2" style="line-height: 1.2; word-break: break-all;">
                        ${estrelas || '⚪'}${estrelasExtra ? `<span class="text-sm text-yellow-600 ml-1">${estrelasExtra}</span>` : ''}
                    </div>
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold text-yellow-600">${numAgendamentos}</span> 
                        agendamento${numAgendamentos !== 1 ? 's' : ''}
                    </p>
                </div>
                ${numAgendamentos > 0 && dadosResp.empresas ? `
                    <button onclick="mostrarEmpresasResponsavel('${responsavel}', this)" 
                            class="w-full text-sm bg-white text-yellow-700 border border-yellow-300 rounded px-3 py-2 hover:bg-yellow-50 transition-colors"
                            data-empresas='${empresasData}'>
                        Ver Empresas (${contadorEmpresas})
                    </button>
                ` : ''}
            </div>
        `;
    }).join('');
    
    // Scroll para o quadro
    quadroVisualSection.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Função para mostrar empresas de um responsável específico - GARANTINDO ESCOPO GLOBAL
function mostrarEmpresasResponsavel(responsavel, botaoClicado) {
    const listaEmpresas = document.getElementById('listaEmpresas');
    const empresasDetalhadas = document.getElementById('empresasDetalhadas');
    
    if (!listaEmpresas || !empresasDetalhadas || !botaoClicado) {
        console.error('Elementos necessários não encontrados');
        return;
    }
    
    const empresasData = botaoClicado.getAttribute('data-empresas');
    
    if (!empresasData) {
        alert('Dados das empresas não encontrados.');
        return;
    }
    
    let listaEmpresas_parsed;
    try {
        listaEmpresas_parsed = JSON.parse(empresasData);
    } catch (error) {
        // Se falhar o parse, tratar como string simples
        console.log('Tratando como string simples:', empresasData);
        listaEmpresas_parsed = [empresasData];
    }
    
    // Garantir que é um array
    if (!Array.isArray(listaEmpresas_parsed)) {
        listaEmpresas_parsed = [listaEmpresas_parsed];
    }
    
    if (listaEmpresas_parsed.length === 0) {
        alert('Nenhuma empresa encontrada para este responsável.');
        return;
    }
    
    empresasDetalhadas.innerHTML = `
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-6 border border-yellow-200">
            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-yellow-500">⭐</span>
                Empresas de ${responsavel} (${listaEmpresas_parsed.length})
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${listaEmpresas_parsed.map((empresa, index) => {
                    // Tratar diferentes formatos de dados da empresa
                    let nomeEmpresa = '';
                    let dataEmpresa = '';
                    
                    if (typeof empresa === 'string') {
                        nomeEmpresa = empresa;
                    } else if (typeof empresa === 'object' && empresa !== null) {
                        nomeEmpresa = empresa.empresa || empresa.nome || empresa.razao_social || 'Empresa não identificada';
                        dataEmpresa = empresa.data || empresa.data_agendamento || '';
                    } else {
                        nomeEmpresa = 'Empresa não identificada';
                    }
                    
                    return `
                        <div class="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h5 class="font-semibold text-gray-900">${nomeEmpresa}</h5>
                                    ${dataEmpresa ? `<p class="text-sm text-gray-600">${new Date(dataEmpresa).toLocaleDateString('pt-BR')}</p>` : ''}
                                </div>
                                <span class="text-yellow-500 text-lg">⭐</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            <button onclick="fecharListaEmpresas()" 
                    class="mt-4 text-sm text-gray-600 hover:text-gray-800 underline">
                Fechar Lista
            </button>
        </div>
    `;
    
    listaEmpresas.style.display = 'block';
    listaEmpresas.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Função auxiliar para fechar a lista de empresas - GARANTINDO ESCOPO GLOBAL
function fecharListaEmpresas() {
    const listaEmpresas = document.getElementById('listaEmpresas');
    if (listaEmpresas) {
        listaEmpresas.style.display = 'none';
    }
}

// GARANTIR QUE AS FUNÇÕES ESTEJAM NO ESCOPO GLOBAL
window.mostrarEmpresasResponsavel = mostrarEmpresasResponsavel;
window.fecharListaEmpresas = fecharListaEmpresas;
</script>
</body>
</html>