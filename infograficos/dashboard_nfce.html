<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Vendas - Bling NFC-e</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header h1 { color: #2c3e50; font-size: 1.8em; }
        .header small { color: #7f8c8d; display: block; margin-top: 5px; }
        
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .controls label { font-weight: 600; color: #555; }
        .controls input, .controls select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .controls input:focus, .controls select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-card .icon { font-size: 2.5em; margin-bottom: 10px; }
        .kpi-card .label { color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px; text-transform: uppercase; }
        .kpi-card .value { color: #2c3e50; font-size: 2.2em; font-weight: bold; }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            padding-left: 15px;
            font-size: 1.3em;
        }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        th { background: #f8f9fa; font-weight: 600; color: #555; text-transform: uppercase; font-size: 0.85em; }
        tr:hover { background: #f8f9fa; }
        .valor { font-weight: 600; color: #27ae60; }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading.show { display: flex; }
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .alert-error { background: #fee; color: #c33; border-left: 5px solid #c33; }
        .alert-success { background: #efe; color: #3c3; border-left: 5px solid #3c3; }
        
        @media (max-width: 1200px) { 
            .grid-2 { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Carregando dados...</h3>
            <p id="loadingMsg">Aguarde, processando notas fiscais</p>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div>
                <h1>üìä Dashboard de Vendas - NFC-e Bling</h1>
                <small id="lastUpdate">Aguardando primeira busca...</small>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="toggleAutoRefresh()" id="btnRefresh">
                    üîÑ Auto-Atualizar
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="controls">
            <label>üìÖ Data In√≠cio:</label>
            <input type="date" id="dataInicio">
            
            <label>üìÖ Data Fim:</label>
            <input type="date" id="dataFim">
            
            <label>üìä M√°x. Notas:</label>
            <select id="limit">
                <option value="50">50</option>
                <option value="100" selected>100</option>
            </select>
            
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="detalhado">
                üë• Dados de Cliente (mais lento)
            </label>
            
            <button class="btn btn-primary" onclick="carregarDados()">
                üîç Buscar Dados
            </button>
            
            <button class="btn btn-success" onclick="exportarCSV()">
                üì• Exportar CSV
            </button>
        </div>

        <div id="dashboard">
            <!-- KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="icon">üí∞</div>
                    <div class="label">Faturamento Total</div>
                    <div class="value" id="kpiFaturamento">R$ 0,00</div>
                </div>
                <div class="kpi-card">
                    <div class="icon">üìÑ</div>
                    <div class="label">Notas Emitidas</div>
                    <div class="value" id="kpiNotas">0</div>
                </div>
                <div class="kpi-card">
                    <div class="icon">üéØ</div>
                    <div class="label">Ticket M√©dio</div>
                    <div class="value" id="kpiTicket">R$ 0,00</div>
                </div>
                <div class="kpi-card">
                    <div class="icon">üì¶</div>
                    <div class="label">Itens Vendidos</div>
                    <div class="value" id="kpiItens">0</div>
                </div>
            </div>

            <!-- Performance por Loja -->
            <div class="section">
                <h3>üè™ Performance por Loja</h3>
                <table id="tabelaLojas">
                    <thead>
                        <tr>
                            <th>Loja</th>
                            <th>Notas</th>
                            <th>Itens</th>
                            <th>Faturamento</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Gr√°ficos: Vendas por Dia e Hora -->
            <div class="grid-2">
                <div class="section">
                    <h3>üìÖ Vendas por Dia</h3>
                    <canvas id="chartVendasDia"></canvas>
                </div>
                <div class="section">
                    <h3>‚è∞ Vendas por Hora</h3>
                    <canvas id="chartVendasHora"></canvas>
                </div>
            </div>

            <!-- Top Produtos e Marcas -->
            <div class="grid-2">
                <div class="section">
                    <h3>üèÜ Top 10 Produtos</h3>
                    <table id="tabelaProdutos">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Produto</th>
                                <th>Marca</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="section">
                    <h3>üè∑Ô∏è Desempenho por Marca</h3>
                    <table id="tabelaMarcas">
                        <thead>
                            <tr>
                                <th>Marca</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Clientes (Vis√≠vel apenas se detalhado = true) -->
            <div class="grid-2" id="clientesSection" style="display: none;">
                <div class="section">
                    <h3>üë• Clientes por G√™nero</h3>
                    <canvas id="chartGenero"></canvas>
                </div>
                <div class="section">
                    <h3>üéÇ Clientes por Faixa Et√°ria</h3>
                    <canvas id="chartIdade"></canvas>
                </div>
            </div>

            <!-- √öltimas Vendas -->
            <div class="section">
                <h3>üïí √öltimas Vendas (Real-Time)</h3>
                <table id="tabelaVendasRealTime">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Hora</th>
                            <th>Loja</th>
                            <th>Produto</th>
                            <th>Marca</th>
                            <th>Quantidade</th>
                            <th>Valor</th>
                            <th>Nota</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dadosGlobais = null;
        let autoRefreshInterval = null;
        let chartVendasDia, chartVendasHora, chartGenero, chartIdade;

        // Fun√ß√£o para formatar valores monet√°rios
        function formatarValor(valor) {
            return 'R$ ' + Number(valor).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Definir datas padr√£o (hoje)
        function setDefaultDates() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataInicio').value = hoje;
            document.getElementById('dataFim').value = hoje;
        }

        // Mostrar/esconder loading
        function toggleLoading(show, message = 'Aguarde, processando notas fiscais') {
            const loading = document.getElementById('loading');
            loading.classList.toggle('show', show);
            document.getElementById('loadingMsg').textContent = message;
        }

        // Mostrar alerta
        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
        }

        // Limpar alerta
        function clearAlert() {
            document.getElementById('alertContainer').innerHTML = '';
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            const btn = document.getElementById('btnRefresh');
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = 'üîÑ Auto-Atualizar';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-success');
                showAlert('Auto-atualiza√ß√£o desativada', 'success');
            } else {
                autoRefreshInterval = setInterval(carregarDados, 60000); // Atualiza a cada 60s
                btn.textContent = 'üõë Parar Auto-Atualiza√ß√£o';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                showAlert('Auto-atualiza√ß√£o ativada (a cada 60s)', 'success');
            }
        }

        // Carregar dados
        async function carregarDados() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const limit = document.getElementById('limit').value;
            const detalhado = document.getElementById('detalhado').checked;

            if (!dataInicio || !dataFim) {
                showAlert('Por favor, selecione as datas de in√≠cio e fim.');
                return;
            }

            // Verificar per√≠odo longo
            const start = new Date(dataInicio);
            const end = new Date(dataFim);
            const diffDays = (end - start) / (1000 * 60 * 60 * 24);
            if (diffDays > 7 && detalhado) {
                showAlert('Per√≠odos acima de 7 dias com dados de cliente podem ser lentos. Considere reduzir o intervalo ou desmarcar "Dados de Cliente".', 'error');
                return;
            }

            toggleLoading(true, 'Buscando notas fiscais...');
            document.getElementById('dashboard').style.opacity = '0.5';
            clearAlert();

            try {
                const url = `/api/bling-nfce?dataInicio=${dataInicio}&dataFim=${dataFim}&limit=${limit}&detalhado=${detalhado}`;
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok || data.status === 'error') {
                    throw new Error(data.message || 'Erro ao buscar dados');
                }

                dadosGlobais = data;

                // Atualizar √∫ltima atualiza√ß√£o
                document.getElementById('lastUpdate').textContent = `√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')} (Processado em ${data.tempoProcessamento})`;

                // Atualizar KPIs
                const resumo = data.dados.resumo;
                document.getElementById('kpiFaturamento').textContent = formatarValor(resumo.totalVendas);
                document.getElementById('kpiNotas').textContent = resumo.totalNotas;
                document.getElementById('kpiTicket').textContent = formatarValor(resumo.ticketMedio);
                document.getElementById('kpiItens').textContent = resumo.totalItens;

                // Tabela de Lojas
                const tbodyLojas = document.getElementById('tabelaLojas').querySelector('tbody');
                tbodyLojas.innerHTML = data.dados.lojasArray.map(loja => `
                    <tr>
                        <td>${loja.nome}</td>
                        <td>${loja.notas}</td>
                        <td>${loja.itens}</td>
                        <td class="valor">${formatarValor(loja.vendas)}</td>
                    </tr>
                `).join('');

                // Tabela de Produtos
                const tbodyProdutos = document.getElementById('tabelaProdutos').querySelector('tbody');
                tbodyProdutos.innerHTML = data.dados.produtosTop.map(prod => `
                    <tr>
                        <td>${prod.codigo}</td>
                        <td>${prod.descricao}</td>
                        <td>${prod.marca}</td>
                        <td>${prod.quantidade}</td>
                        <td class="valor">${formatarValor(prod.valorTotal)}</td>
                    </tr>
                `).join('');

                // Tabela de Marcas
                const tbodyMarcas = document.getElementById('tabelaMarcas').querySelector('tbody');
                tbodyMarcas.innerHTML = data.dados.marcasArray.map(marca => `
                    <tr>
                        <td>${marca.marca}</td>
                        <td>${marca.quantidade}</td>
                        <td class="valor">${formatarValor(marca.vendas)}</td>
                    </tr>
                `).join('');

                // Tabela de Vendas Real-Time
                const tbodyVendasRealTime = document.getElementById('tabelaVendasRealTime').querySelector('tbody');
                tbodyVendasRealTime.innerHTML = data.dados.vendasRealTime.map(venda => `
                    <tr>
                        <td>${venda.data}</td>
                        <td>${venda.hora}</td>
                        <td>${venda.loja}</td>
                        <td>${venda.produto}</td>
                        <td>${venda.marca}</td>
                        <td>${venda.quantidade}</td>
                        <td class="valor">${formatarValor(venda.valor)}</td>
                        <td>${venda.numeroNota}</td>
                    </tr>
                `).join('');

                // Gr√°fico de Vendas por Dia
                if (chartVendasDia) chartVendasDia.destroy();
                chartVendasDia = new Chart(document.getElementById('chartVendasDia'), {
                    type: 'bar',
                    data: {
                        labels: data.dados.diasArray.map(d => d.data),
                        datasets: [{
                            label: 'Faturamento por Dia',
                            data: data.dados.diasArray.map(d => d.vendas),
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Faturamento (R$)' } },
                            x: { title: { display: true, text: 'Data' } }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // Gr√°fico de Vendas por Hora
                if (chartVendasHora) chartVendasHora.destroy();
                chartVendasHora = new Chart(document.getElementById('chartVendasHora'), {
                    type: 'line',
                    data: {
                        labels: data.dados.horasArray.map(h => h.hora),
                        datasets: [{
                            label: 'Faturamento por Hora',
                            data: data.dados.horasArray.map(h => h.vendas),
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Faturamento (R$)' } },
                            x: { title: { display: true, text: 'Hora' } }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // Gr√°ficos de Clientes (se detalhado)
                document.getElementById('clientesSection').style.display = detalhado ? 'grid' : 'none';
                if (detalhado) {
                    // Gr√°fico de G√™nero
                    if (chartGenero) chartGenero.destroy();
                    chartGenero = new Chart(document.getElementById('chartGenero'), {
                        type: 'pie',
                        data: {
                            labels: data.dados.clientes.generoArray.map(g => g.genero),
                            datasets: [{
                                label: 'Clientes por G√™nero',
                                data: data.dados.clientes.generoArray.map(g => g.count),
                                backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56'],
                                borderColor: ['#2A8ABF', '#D63D5C', '#D4A017'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });

                    // Gr√°fico de Faixa Et√°ria
                    if (chartIdade) chartIdade.destroy();
                    chartIdade = new Chart(document.getElementById('chartIdade'), {
                        type: 'bar',
                        data: {
                            labels: data.dados.clientes.idadeArray.map(i => i.faixa),
                            datasets: [{
                                label: 'Clientes por Faixa Et√°ria',
                                data: data.dados.clientes.idadeArray.map(i => i.count),
                                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'N√∫mero de Clientes' } },
                                x: { title: { display: true, text: 'Faixa Et√°ria' } }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }

                document.getElementById('dashboard').style.opacity = '1';
                toggleLoading(false);
                showAlert(`Dados carregados com sucesso! ${data.totalProcessado} notas processadas.`, 'success');
            } catch (error) {
                toggleLoading(false);
                document.getElementById('dashboard').style.opacity = '1';
                showAlert(`Erro: ${error.message}. Tente reduzir o per√≠odo ou o limite de notas.`, 'error');
            }
        }

        // Exportar CSV
        function exportarCSV() {
            if (!dadosGlobais) {
                showAlert('Carregue os dados primeiro!');
                return;
            }

            const { dados, periodo } = dadosGlobais;
            let csv = '"Data";"Hora";"Loja";"Produto";"Marca";"Quantidade";"Valor";"Nota"\n';

            dados.vendas.forEach(venda => {
                csv += `"${venda.data}";"${venda.hora}";"${venda.loja}";"${venda.produto.replace(/"/g, '""')}";"${venda.marca}";"${venda.quantidade}";"${venda.valor}";"${venda.numeroNota}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `vendas_${periodo.dataInicio}_${periodo.dataFim}.csv`;
            link.click();
            showAlert('CSV exportado com sucesso!', 'success');
        }

        // Inicializar
        setDefaultDates();
        document.getElementById('dashboard').style.opacity = '1';
    </script>
</body>
</html>
