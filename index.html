<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas - Exagerado</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="shortcut icon" href="imagens/favicon.ico" type="image/x-icon">

    <style>
        /* Variáveis de cores ajustadas para combinar com o e-commerce */
        :root {
            --color-primary-green: #57da1c; /* Verde de ação */
            --color-secondary-purple: #E54E88; /* Rosa/magenta de destaque */
            --color-dark-blue: #222222; /* Cinza escuro para textos e fundo */
            --color-accent-orange: #f95b3c; /* Laranja vibrante */
            --color-light-gray-bg: #FDF9F3; /* Fundo principal quase branco */
            --color-white: #FFFFFF;
            --color-text-dark: #4A5568; /* Texto padrão */
            --color-light-hover: #F8F8F8; /* Hover mais suave */
        }

        /* Estilos gerais com a nova fonte e cores */
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: var(--color-light-gray-bg); 
            color: var(--color-text-dark); 
        }

        /* Estilos dos cards de KPI (e do seu section principal agora) */
        .kpi-card { 
            background-color: var(--color-white); 
            border-radius: 1rem; /* Mais arredondado */
            padding: 2rem; /* Mais espaçoso */
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Sombra mais suave e proeminente */
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            border-left: 6px solid var(--color-secondary-purple); /* Borda esquerda mais grossa */
        }
        .kpi-card:hover { 
            transform: translateY(-8px); /* Efeito de elevação maior */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12); /* Sombra maior no hover */
        }
        .kpi-value { 
            font-size: 2.8rem; /* Um pouco maior */
            font-weight: 800; /* Mais negrito */
            color: var(--color-accent-orange); /* Usando a cor laranja vibrante para os valores */
            margin-bottom: 0.5rem;
        }
        .kpi-label {
            font-weight: 700;
            color: var(--color-text-dark);
            font-size: 1.2rem;
        }
        .kpi-description {
            font-size: 0.9rem;
            color: #718096; /* Cinza mais suave */
            margin-top: 0.5rem;
        }

        /* Estilos dos campos de formulário */
        .form-input, .form-select { 
            background-color: var(--color-white); 
            border: 1px solid #e2e8f0; /* Borda mais clara */
            border-radius: 0.75rem; /* Mais arredondado */
            color: var(--color-text-dark); 
            padding: 0.85rem 1.25rem; /* Mais padding */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-size: 1rem;
        }
        .form-input::placeholder {
            color: #A0AEC0; /* Placeholder mais visível */
        }
        .form-input:focus, .form-select:focus { 
            border-color: var(--color-secondary-purple); /* Borda rosa ao focar */
            box-shadow: 0 0 0 3px rgba(229, 78, 136, 0.25); /* Sombra suave de foco */
            outline: none; 
        }

        /* Estilos do botão de predição */
        .btn-predict { 
            background: linear-gradient(90deg, var(--color-primary-green), var(--color-accent-orange)); /* Gradiente na horizontal */
            border: none; 
            border-radius: 0.75rem; /* Mais arredondado */
            color: var(--color-white); 
            font-weight: 800; /* Mais negrito */
            padding: 0.95rem 1.75rem; /* Mais padding */
            transition: all 0.3s ease; 
            cursor: pointer; 
            letter-spacing: 0.05em; /* Espaçamento entre letras */
            text-transform: uppercase; /* Texto em maiúsculas */
        }
        .btn-predict:hover { 
            transform: translateY(-4px); /* Elevação maior */
            box-shadow: 0 12px 30px rgba(249, 91, 60, 0.35); /* Sombra maior e mais colorida */
        }
        .btn-predict:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none;
        }
        .spinner { 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 50% !important;
            border-top: 2px solid white; 
            width: 20px; /* Maior */
            height: 20px; /* Maior */
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px; /* Mais espaço */
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Estilos para o card de resultado */
        #resultado-previsao {
            background-color: var(--color-white);
            border: 2px dashed var(--color-secondary-purple); /* Borda tracejada rosa */
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 5px 15px rgba(229, 78, 136, 0.1); /* Sombra leve com tom rosa */
        }
        #resultado-previsao h3 {
            color: var(--color-accent-orange); /* Título em laranja vibrante */
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
        }
        #resultado-previsao p {
            color: var(--color-text-dark);
            font-size: 1.15rem;
            line-height: 1.6;
        }

        /* Outros estilos do seu código original */
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: auto; height: 350px; max-height: 400px; }
        .nav-item { padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s ease, color 0.3s ease; text-decoration: none; font-weight: 600; color: var(--color-text-dark); }
        .nav-item:hover { background-color: var(--color-light-hover); color: var(--color-dark-blue); }
        .nav-item.active { background-color: var(--color-primary-green); color: var(--color-white); }
    </style>
</head>
<body class="text-gray-800">
    <script>
  // O token do usuário logado
  const token = localStorage.getItem("token");

  // Se não houver token, redireciona imediatamente
  if (!token) {
    window.location.href = "login.html";
  }

  // Função para verificar se o token é válido
  async function checkAuth() {
    try {
      const response = await fetch("https://api-login-zmcb.onrender.com/dados-protegidos", {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });
      
      // Se a resposta não for OK (por exemplo, 401), redireciona
      if (!response.ok) {
        throw new Error("Token inválido ou expirado.");
      }
      
      console.log("Token válido. O usuário pode continuar.");
      // Aqui você poderia carregar dados ou exibir o conteúdo
      // document.body.style.display = 'block'; // Se o body estiver hidden inicialmente
    } catch (error) {
      console.error("Erro de autenticação:", error);
      localStorage.removeItem("token"); // Limpa o token inválido
      window.location.href = "login.html"; // Redireciona para o login
    }
  }
  
  // Executa a verificação
  checkAuth();
</script>
<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-[var(--color-dark-blue)] mb-4">
            Dashboard de Performance em Vendas <br class="md:hidden">
            <span class="text-[var(--color-accent-orange)]">Exagerado</span>
        </h1>
        <p class="text-lg text-gray-600 max-w-3xl mx-auto">Navegue pelas análises de desempenho de vendas ao longo do tempo.</p>
    </header>

    <nav class="mb-12 kpi-card rounded-lg shadow-md p-6 max-w-4xl mx-auto border-l-4 border-[var(--color-secondary-purple)]">
        <a href="infograficos/infografico_desempenho_d_s.html" class="nav-item">Desempenho Diário e Semanal</a>
        <a href="infograficos/infografico_jun_2025.html" class="nav-item">Junho 2025</a>
        <a href="infograficos/infografico_jul_2025.html" class="nav-item active">Julho 2025 (Atual)</a>

    </nav>

    <main>

        <!-- Ferramenta de Previsão -->
        <section id="prediction-tool" class="mb-16 kpi-card max-w-5xl mx-auto">
            <div class="p-4">
                <h2 class="text-4xl font-extrabold text-center mb-6 text-[var(--color-accent-orange)]">Ferramenta de Previsão</h2>
                <p class="text-center mb-10 text-lg text-gray-700 leading-relaxed">
                    Utilize o modelo treinado para prever o andamento de novas negociações e otimizar suas estratégias de vendas.
                </p>

                <form id="form-previsao" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div>
                        <label for="pipeline" class="block font-semibold mb-2 text-[var(--color-text-dark)]">Pipeline</label>
                        <select id="pipeline" class="form-select w-full">
                            <option value="" disabled selected>Selecione a Pipeline</option>
                            <option value="SÃO PAULO">SÃO PAULO</option>
                            <option value="CACHOEIRO">CACHOEIRO</option>
                            <option value="PAVILHÃO OUTUBRO">PAVILHÃO OUTUBRO</option>
                            <option value="RIO DE JANEIRO">RIO DE JANEIRO</option>
                        </select>
                    </div>
                    <div>
                        <label for="ticket" class="block font-semibold mb-2 text-[var(--color-text-dark)]">Ticket (R$)</label>
                        <input type="number" id="ticket" placeholder="Ex: 200" class="form-input w-full">
                    </div>
                    <div>
                        <label for="lojas" class="block font-semibold mb-2 text-[var(--color-text-dark)]">Lojas</label>
                        <input type="number" id="lojas" placeholder="Ex: 3" class="form-input w-full">
                    </div>
                    <div>
                        <label for="funcionarios" class="block font-semibold mb-2 text-[var(--color-text-dark)]">Funcionários</label>
                        <input type="number" id="funcionarios" placeholder="Ex: 5" class="form-input w-full">
                    </div>
                    <div class="md:col-span-2 lg:col-span-3">
                        <label for="segmento" class="block font-semibold mb-2 text-[var(--color-text-dark)]">Segmento</label>
                        <select id="segmento" class="form-select w-full">
                            <option value="" disabled selected>Selecione o Segmento</option>
                            <option value="Calçados">Calçados</option>
                            <option value="Moda/Vestuário">Moda/Vestuário</option>
                            <option value="Acessórios/Joias">Acessórios/Joias</option>
                            <option value="Brinquedos/Infantil">Brinquedos/Infantil</option>
                            <option value="Casa/Decoração">Casa/Decoração</option>
                            <option value="Comércio/Indústria">Comércio/Indústria</option>
                            <option value="Cosméticos/Perfumaria">Cosméticos/Perfumaria</option>
                        </select>
                    </div>
                    <div class="lg:col-span-1 flex items-end">
                        <button type="submit" class="btn-predict w-full" id="btn-predict">Prever Andamento</button>
                    </div>
                </form>

                <div id="resultado-previsao" class="kpi-card hidden text-center">
                    <h3 class="mb-4">Resultado da Previsão</h3>
                    <p class="text-xl">Avança com <strong class="text-[var(--color-accent-orange)]">65.2%</strong> de probabilidade.</p>
                </div>
            </div>
        </section>

        <!-- Gráfico de Agendamentos -->
        <section id="monthly-appointments-overview" class="mb-16 kpi-card rounded-lg shadow-md p-6 max-w-4xl mx-auto border-l-4 border-[var(--color-secondary-purple)]">
            <h2 class="text-3xl font-bold text-center mb-8 text-[var(--color-accent-orange)]">Agendamentos Totais por Mês</h2>
            <p class="text-center text-gray-600 mb-8">Acompanhe a evolução do número total de agendamentos mês a mês.</p>
            <div class="chart-container">
                <canvas id="monthlyAppointmentsChart"></canvas>
            </div>
            <p class="text-sm text-gray-600 text-center mt-4">Este gráfico reflete o somatório de todos os agendamentos realizados pela equipe no período.</p>
        </section>
    </main>

    <footer class="text-center mt-16 text-gray-500 text-sm">
        <p>&copy; 2025 Exagerado. Todos os direitos reservados.</p>
    </footer>
</div>

<script>
const API_URL = "https://api-andamento.onrender.com";
const formPrevisao = document.getElementById("form-previsao");
const resultadoDiv = document.getElementById("resultado-previsao");
const btnPredict = document.getElementById("btn-predict");

formPrevisao.addEventListener("submit", async function(event) {
    event.preventDefault();

    // Lógica para desabilitar o botão e mostrar o loading
    btnPredict.disabled = true;
    btnPredict.innerHTML = '<span class="spinner"></span>Processando...';

    // Oculta e limpa o card de resultado para o novo processamento
    resultadoDiv.classList.add('hidden');
    resultadoDiv.innerHTML = '';
    
    const dados = {
        pipeline: document.getElementById("pipeline").value,
        ticket: parseFloat(document.getElementById("ticket").value),
        lojas: parseInt(document.getElementById("lojas").value),
        funcionarios: parseInt(document.getElementById("funcionarios").value),
        segmento: document.getElementById("segmento").value
    }

    try {
        const response = await fetch(`${API_URL}/prever_andamento`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados),
        });

        let data;
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            data = await response.json();
        } else {
            throw new Error(`Erro na API. O formato da resposta é inesperado.`);
        }

        if (!response.ok) {
            throw new Error(data.error || `Erro HTTP: ${response.status}`);
        }
        if (data.error) {
            throw new Error(data.error);
        }

        // AQUI ESTÁ A LÓGICA CORRIGIDA E FINAL
        let message = '';
        let probabilidadeAvanca = 0;
        let probabilidadeNaoAvanca = 0;
        
        // Acessa o texto correto dentro do array retornado pela API
        const stringPrevisao = Array.isArray(data.previsao) ? data.previsao[0] : data.previsao;
        
        // Expressão regular para capturar números com ou sem decimais
        const regex = /(\d+[,.]?\d*)/;

        if (typeof stringPrevisao === 'string') {
            const match = stringPrevisao.match(regex);
            if (match && match[1]) {
                const numeroString = match[1].replace(',', '.');
                const valor = parseFloat(numeroString);

                if (stringPrevisao.includes('Avança')) {
                    probabilidadeAvanca = valor;
                    probabilidadeNaoAvanca = (100 - valor).toFixed(1);
                } else {
                    probabilidadeNaoAvanca = valor;
                    probabilidadeAvanca = (100 - valor).toFixed(1);
                }
            }
        }

        let mensagemAvanca = '';
        if (probabilidadeAvanca >= 80) {
            mensagemAvanca = `<p class="text-green-600 font-semibold mt-2">A chance de avançar é alta. Vale a pena investir!</p>`;
        } else if (probabilidadeAvanca >= 50){
            mensagemAvanca = `<p class="text-gray-600 mt-2">A chance de avançar é baixa. Considere os riscos.</p>`;
        } else {
            mensagemAvanca = `<p class="text-orange-500 font-semibold mt-2">A chance de avançar é baixa. Considere os riscos.</p>`;
        }

        let mensagemNaoAvanca = '';
        if (probabilidadeNaoAvanca >= 80) {
            mensagemNaoAvanca = `<p class="text-red-600 font-semibold mt-2">O risco é alto. Considere encerrar a negociação.</p>`;
        } else if (probabilidadeNaoAvanca >=50) {
            mensagemNaoAvanca = `<p class="text-gray-600 mt-2">O risco de não avançar é moderado. Acompanhe de perto.</p>`;
        } else {
            mensagemNaoAvanca = `<p class="text-orange-500 font-semibold mt-2">O risco de não avançar é baixo. Avance com mais confiança!</p>`;
        }

        message = `
            <h3 class="text-2xl font-bold mb-2">Resultado da Previsão</h3>
            <p class="text-lg mb-4">${stringPrevisao}</p>
            <div class="flex flex-col md:flex-row justify-center gap-8 text-gray-800">
                <div class="p-4 rounded-lg bg-green-50 border border-green-200">
                    <p class="text-sm opacity-80">Avança</p>
                    <p class="text-2xl font-bold text-green-700">${probabilidadeAvanca}%</p>
                    ${mensagemAvanca}
                </div>
                <div class="p-4 rounded-lg bg-red-50 border border-red-200">
                    <p class="text-sm opacity-80">Não Avança</p>
                    <p class="text-2xl font-bold text-red-700">${probabilidadeNaoAvanca}%</p>
                    ${mensagemNaoAvanca}
                </div>
            </div>
        `;

        resultadoDiv.innerHTML = message;
        resultadoDiv.classList.remove('hidden');

    } catch (error) {
        resultadoDiv.innerHTML = `<h3 class="text-xl font-bold mb-2">Erro na Previsão</h3><p class="text-red-600">${error.message}</p>`;
    } finally {
        btnPredict.disabled = false;
        btnPredict.innerHTML = 'Prever Andamento';
    }
});

// Gráfico de Agendamentos
function createMonthlyAppointmentsChart(elementId, labels, data) {
    const ctx = document.getElementById(elementId).getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'Agendamentos Totais', data: data, borderColor: '#004D7A', backgroundColor: 'rgba(0,77,122,0.2)', fill: true, tension: 0.4, pointBackgroundColor: '#004D7A', pointRadius: 5, pointHoverRadius: 7 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' } }, scales: { x: { title: { display: true, text: 'Mês' }, grid: { display: false } }, y: { title: { display: true, text: 'Agendamentos' }, beginAtZero: true, ticks: { precision: 0 } } } }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    createMonthlyAppointmentsChart('monthlyAppointmentsChart', ['Junho', 'Julho'], [52, 143]);
});

// Este listener tem a única função de validar os campos antes que a ação principal ocorra.
btnPredict.addEventListener('click', function(event) {
    // Array com os IDs dos campos obrigatórios
    const camposParaValidar = [
        'pipeline',
        'ticket',
        'lojas',
        'funcionarios',
        'segmento'
    ];

    // Verifica se algum campo está vazio
    const algumCampoVazio = camposParaValidar.some(campoId => {
        const selectElement = document.getElementById(campoId);
        return selectElement.value === "";
    });

    if (algumCampoVazio) {
        // Previne que a ação padrão do botão (como submissão de formulário) aconteça
        event.preventDefault(); 
        
        // Exibe o pop-up de erro
        Swal.fire({
          icon: 'error',
          title: 'Erro!',
          text: 'Por favor, preencha os campos devidamente antes de usar a ferramenta.'
        });
        
        return; // A execução do script para aqui
    }

    // Se todos os campos estiverem preenchidos, o script do listener termina.
    // A ação principal (predição) pode ser executada agora por outro código.
});
</script>
</body>
</html>
