<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas - Exagerado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="shortcut icon" href="imagens/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary-green: #61BB46;
            --color-secondary-purple: #5C3E8A;
            --color-dark-blue: #004D7A;
            --color-accent-orange: #F47721;
            --color-accent-teal: #00BFB2;
            --color-accent-yellow: #FDBB2D;
            --color-light-gray-bg: #f0f4f8;
            --color-white: #FFFFFF;
            --color-text-dark: #4A5568;
            --color-light-hover: #E2E8F0;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-light-gray-bg); color: var(--color-text-dark); }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: auto; height: 350px; max-height: 400px; }
        .kpi-card { background-color: var(--color-white); border-radius: 0.75rem; padding: 1.5rem; text-align: center; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .nav-item { padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s ease, color 0.3s ease; text-decoration: none; font-weight: 600; color: var(--color-text-dark); }
        .nav-item:hover { background-color: var(--color-light-hover); color: var(--color-dark-blue); }
        .nav-item.active { background-color: var(--color-primary-green); color: var(--color-white); }
        .form-input, .form-select { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: black; backdrop-filter: blur(10px); }
        .form-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .form-input:focus, .form-select:focus { border-color: var(--color-primary-green); box-shadow: 0 0 0 3px rgba(97, 187, 70, 0.1); outline: none; }
        .btn-predict { background: linear-gradient(45deg, var(--color-primary-green), #4ade80); border: none; border-radius: 8px; color: white; font-weight: 600; padding: 12px 24px; transition: all 0.3s ease; cursor: pointer; }
        .btn-predict:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(97, 187, 70, 0.3); }
        .btn-predict:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">
    <script>
  // O token do usuário logado
  const token = localStorage.getItem("token");

  // Se não houver token, redireciona imediatamente
  if (!token) {
    window.location.href = "login.html";
  }

  // Função para verificar se o token é válido
  async function checkAuth() {
    try {
      const response = await fetch("https://api-login-zmcb.onrender.com/dados-protegidos", {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });
      
      // Se a resposta não for OK (por exemplo, 401), redireciona
      if (!response.ok) {
        throw new Error("Token inválido ou expirado.");
      }
      
      console.log("Token válido. O usuário pode continuar.");
      // Aqui você poderia carregar dados ou exibir o conteúdo
      // document.body.style.display = 'block'; // Se o body estiver hidden inicialmente
    } catch (error) {
      console.error("Erro de autenticação:", error);
      localStorage.removeItem("token"); // Limpa o token inválido
      window.location.href = "login.html"; // Redireciona para o login
    }
  }
  
  // Executa a verificação
  checkAuth();
</script>
<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-[var(--color-dark-blue)] mb-4">
            Dashboard de Performance em Vendas <br class="md:hidden">
            <span class="text-[var(--color-primary-green)]">Exagerado</span>
        </h1>
        <p class="text-lg text-gray-600 max-w-3xl mx-auto">Navegue pelas análises de desempenho de vendas ao longo do tempo.</p>
    </header>

    <nav class="mb-12 bg-white rounded-lg shadow-md p-4 flex flex-wrap justify-center gap-4">
        <a href="infograficos/infografico_desempenho_d_s.html" class="nav-item">Desempenho Diário e Semanal</a>
        <a href="infograficos/infografico_jun_2025.html" class="nav-item">Junho 2025</a>
        <a href="infograficos/infografico_jul_2025.html" class="nav-item active">Julho 2025 (Atual)</a>

    </nav>

    <main>
        <!-- Gráfico de Agendamentos -->
        <section id="monthly-appointments-overview" class="mb-16 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-3xl font-bold text-center mb-8 text-[var(--color-dark-blue)]">Agendamentos Totais por Mês</h2>
            <p class="text-center text-gray-600 mb-8">Acompanhe a evolução do número total de agendamentos mês a mês.</p>
            <div class="chart-container">
                <canvas id="monthlyAppointmentsChart"></canvas>
            </div>
            <p class="text-sm text-gray-600 text-center mt-4">Este gráfico reflete o somatório de todos os agendamentos realizados pela equipe no período.</p>
        </section>

        <!-- Ferramenta de Previsão -->
        <section id="prediction-tool" class="mb-16 kpi-card bg-white rounded-lg shadow-md p-6 max-w-4xl mx-auto"">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-8 text-[var(--color-dark-blue)]">Ferramenta de Previsão</h2>
                <p class="text-center mb-8 opacity-90">Utilize o modelo treinado para prever o andamento de novas negociações.</p>

                <form id="form-previsao" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="pipeline" class="block font-medium mb-2">Pipeline</label>
                        <select id="pipeline" class="form-select w-full p-3">
                            <option value="SÃO PAULO">SÃO PAULO</option>
                            <option value="CACHOEIRO">CACHOEIRO</option>
                            <option value="PAVILHÃO OUTUBRO">PAVILHÃO OUTUBRO</option>
                            <option value="RIO DE JANEIRO">RIO DE JANEIRO</option>
                        </select>
                    </div>
                    <div>
                        <label for="ticket" class="block font-medium mb-2">Ticket (R$)</label>
                        <input type="number" id="ticket" value="200" class="form-input w-full p-3" placeholder="Ex: 200">
                    </div>
                    <div>
                        <label for="lojas" class="block font-medium mb-2">Lojas</label>
                        <input type="number" id="lojas" value="3" class="form-input w-full p-3" placeholder="Ex: 3">
                    </div>
                    <div>
                        <label for="funcionarios" class="block font-medium mb-2">Funcionários</label>
                        <input type="number" id="funcionarios" value="10" class="form-input w-full p-3" placeholder="Ex: 10">
                    </div>
                    <div class="md:col-span-2">
                        <label for="segmento" class="block font-medium mb-2">Segmento</label>
                        <select id="segmento" class="form-select w-full p-3">
                            <option value="Calçados">Calçados</option>
                            <option value="Moda/Vestuário">Moda/Vestuário</option>
                            <option value="Acessórios/Joias">Acessórios/Joias</option>
                            <option value="Brinquedos/Infantil">Brinquedos/Infantil</option>
                            <option value="Casa/Decoração">Casa/Decoração</option>
                            <option value="Comércio/Indústria">Comércio/Indústria</option>
                            <option value="Cosméticos/Perfumaria">Cosméticos/Perfumaria</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="btn-predict w-full" id="btn-predict">Prever Andamento</button>
                    </div>
                </form>

                <!-- Card de Resultado -->
                <div id="resultado-previsao" class="kpi-card hidden text-center"></div>
            </div>
        </section>
    </main>

    <footer class="text-center mt-16 text-gray-500 text-sm">
        <p>&copy; 2025 Exagerado. Todos os direitos reservados.</p>
    </footer>
</div>

<script>
const API_URL = "https://api-andamento.onrender.com";
const formPrevisao = document.getElementById("form-previsao");
const resultadoDiv = document.getElementById("resultado-previsao");
const btnPredict = document.getElementById("btn-predict");

formPrevisao.addEventListener("submit", async function(event) {
    event.preventDefault();
    btnPredict.disabled = true;
    btnPredict.innerHTML = '<div class="spinner"></div>Processando...';

    resultadoDiv.classList.remove('hidden','result-success','result-error','result-loading');
    resultadoDiv.classList.add('kpi-card');
    resultadoDiv.innerHTML = '<div class="spinner"></div>Fazendo previsão...';

    const dados = {
        pipeline: document.getElementById("pipeline").value,
        ticket: parseFloat(document.getElementById("ticket").value),
        lojas: parseInt(document.getElementById("lojas").value),
        funcionarios: parseInt(document.getElementById("funcionarios").value),
        segmento: document.getElementById("segmento").value
    };

    try {
        const response = await fetch(`${API_URL}/prever_andamento`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados),
        });

        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);

        let message = `<h3 class="text-xl font-bold mb-2">Resultado da Previsão</h3>`;
        message += `<p class="text-lg mb-4">${data.previsao}</p>`;
        if (data.probabilidades) {
            message += `
                <div class="flex justify-center gap-8 text-gray-800">
                    <div>
                        <p class="text-sm opacity-80">Avança</p>
                        <p class="text-lg font-bold">${data.probabilidades.avanca}%</p>
                    </div>
                    <div>
                        <p class="text-sm opacity-80">Não Avança</p>
                        <p class="text-lg font-bold">${data.probabilidades.nao_avanca}%</p>
                    </div>
                </div>
            `;
        }

        resultadoDiv.innerHTML = message;
        resultadoDiv.classList.remove('hidden');

    } catch (error) {
        resultadoDiv.innerHTML = `<h3 class="text-xl font-bold mb-2">Erro na Previsão</h3><p>${error.message}</p>`;
    } finally {
        btnPredict.disabled = false;
        btnPredict.innerHTML = 'Prever Andamento';
    }
});

// Gráfico de Agendamentos
function createMonthlyAppointmentsChart(elementId, labels, data) {
    const ctx = document.getElementById(elementId).getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'Agendamentos Totais', data: data, borderColor: '#004D7A', backgroundColor: 'rgba(0,77,122,0.2)', fill: true, tension: 0.4, pointBackgroundColor: '#004D7A', pointRadius: 5, pointHoverRadius: 7 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' } }, scales: { x: { title: { display: true, text: 'Mês' }, grid: { display: false } }, y: { title: { display: true, text: 'Agendamentos' }, beginAtZero: true, ticks: { precision: 0 } } } }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    createMonthlyAppointmentsChart('monthlyAppointmentsChart', ['Junho', 'Julho'], [52, 143]);
});
</script>
</body>
</html>
