<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Agendamentos e An√°lise Preditiva</title>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-primary-green: #57da1c;
            --color-secondary-purple: #E54E88;
            --color-dark-blue: #222222;
            --color-accent-orange: #f95b3c;
            --color-accent-teal: #00BFB2;
            --color-accent-yellow: #FDBB2D;
            --color-light-gray-bg: #F0F0F0;
            --color-white: #FFFFFF;
            --color-text-dark: #4A5568;
        }
        
        body {
            font-family: 'Nunito', sans-serif; 
            background-color: var(--color-light-gray-bg); 
            color: var(--color-text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .main-header {
            background: linear-gradient(135deg, var(--color-secondary-purple), var(--color-accent-orange));
            color: var(--color-white);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 15px 40px rgba(229, 78, 136, 0.3);
            margin-bottom: 2rem;
        }

        .main-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .btn-warning, .btn-primary, .btn-export {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            color: var(--color-white);
            text-decoration: none;
            border: none;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin: 0.5rem;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-secondary-purple), var(--color-accent-orange));
        }

        .btn-export {
            background: linear-gradient(135deg, var(--color-accent-teal), var(--color-primary-green));
        }

        .btn-warning:hover, .btn-primary:hover, .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .section-card {
            background: var(--color-white);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            border-left: 6px solid var(--color-secondary-purple);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-accent-orange);
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 700;
            color: var(--color-dark-blue);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-secondary-purple);
        }

        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--color-white);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            border-left: 6px solid var(--color-secondary-purple);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-accent-orange);
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            font-weight: 700;
            color: var(--color-text-dark);
            font-size: 1rem;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .empresa-card {
            background: var(--color-white);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-left: 6px solid var(--color-secondary-purple);
            cursor: pointer;
            position: relative;
        }

        .empresa-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .empresa-nome {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--color-dark-blue);
            margin-bottom: 1rem;
        }

        .status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--color-white);
            text-transform: uppercase;
        }

        .status-avancou {
            background: linear-gradient(135deg, var(--color-primary-green), #4ade80);
        }

        .status-nao-avancou {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .status-pendente {
            background: linear-gradient(135deg, var(--color-accent-orange), #e6680a);
        }

        .metric-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .metric-item {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--color-text-dark);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-dark-blue);
        }

        .probability-section {
            background: linear-gradient(135deg, #e0f2fe, #dbeafe);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            border: 2px solid var(--color-accent-teal);
        }

        .probability-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-dark-blue);
            margin-bottom: 0.5rem;
        }

        .probability-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-accent-teal);
        }

        .ml-placeholder {
            background: #fef3c7;
            border: 2px dashed var(--color-accent-yellow);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            color: var(--color-dark-blue);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--color-white);
            border-radius: 1rem;
            width: 90vw;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--color-secondary-purple), var(--color-accent-orange));
            color: var(--color-white);
            padding: 2rem;
            border-radius: 1rem 1rem 0 0;
            position: relative;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 800;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--color-white);
            font-size: 1.5rem;
            padding: 0.5rem 1rem;
            border-radius: 50%;
            cursor: pointer;
        }

        .modal-content {
            padding: 2rem;
        }

        .field-group {
            margin-bottom: 1.5rem;
        }

        .field-label {
            font-weight: 700;
            color: var(--color-dark-blue);
            margin-bottom: 0.5rem;
            display: block;
        }

        .field-value {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .field-value:hover {
            background: #e2e8f0;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: var(--color-text-dark);
        }

        /* Estilos para o relat√≥rio export√°vel */
        .report-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1200px;
            background: white;
            font-family: 'Nunito', sans-serif;
        }

        .report-header {
            background: linear-gradient(135deg, #E54E88, #f95b3c);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .report-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .report-section {
            padding: 1.5rem;
        }

        .report-section h3 {
            color: #E54E88;
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #E54E88;
            padding-bottom: 0.5rem;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .report-kpi {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            border-left: 4px solid #E54E88;
        }

        .report-kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #f95b3c;
        }

        .report-kpi-label {
            font-size: 0.9rem;
            color: #4A5568;
            font-weight: 600;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .report-table th {
            background: #E54E88;
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 700;
        }

        .report-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .report-footer {
            background: #f8fafc;
            padding: 1rem;
            text-align: center;
            color: #4A5568;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1>üéØ Dashboard de Agendamentos e An√°lise Preditiva</h1>
            <p>Gerencie agendamentos e preveja probabilidades de avan√ßo</p>
            <div>
                <a href="index.html" class="btn-warning">‚¨Ö Voltar</a>
                <button onclick="exportReport()" class="btn-export" id="export-btn">üìä Exportar Relat√≥rio PNG</button>
            </div>
        </header>

        <!-- Se√ß√£o de Formul√°rio -->
        <section class="section-card">
            <h2 class="section-title">‚ûï Adicionar Novo Agendamento</h2>
            <form id="agendamentoForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Respons√°vel *</label>
                        <select id="responsavel" class="form-select" required>
                            <option value="">Selecione</option>
                            <option value="Erick">Erick</option>
                            <option value="Kau√£">Kau√£</option>
                            <option value="Bruna Azevedo">Bruna Azevedo</option>
                            <option value="Matheus">Matheus</option>
                            <option value="Priscila Prado">Priscila Prado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome da Empresa *</label>
                        <input type="text" id="empresa" class="form-input" placeholder="Digite o nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data da Reuni√£o *</label>
                        <input type="date" id="dataReuniao" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ticket M√©dio (R$)</label>
                        <input type="number" id="ticketMedio" class="form-input" placeholder="0.00" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">N√∫mero de Lojas</label>
                        <input type="number" id="numeroLojas" class="form-input" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">N√∫mero de Funcion√°rios</label>
                        <input type="number" id="numeroFuncionarios" class="form-input" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Segmento</label>
                        <select id="segmento" class="form-select">
                            <option value="">Selecione</option>
                            <option value="Moda">Moda</option>
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Tecnologia">Tecnologia</option>
                            <option value="Beleza">Beleza</option>
                            <option value="Decora√ß√£o">Decora√ß√£o</option>
                            <option value="Servi√ßos">Servi√ßos</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Local do Evento</label>
                        <input type="text" id="localEvento" class="form-input" placeholder="Cidade/Estado">
                    </div>
                </div>
                
                <button type="submit" class="btn-primary">‚úÖ Adicionar Agendamento</button>
            </form>
        </section>

        <!-- KPIs -->
        <section class="kpi-section hidden" id="kpis-section">
            <div class="kpi-card">
                <div class="kpi-value" id="total-agendamentos">0</div>
                <div class="kpi-label">Total Agendamentos</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="total-avancou">0</div>
                <div class="kpi-label">Avan√ßaram</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="total-pendentes">0</div>
                <div class="kpi-label">Pendentes</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="taxa-conversao">0%</div>
                <div class="kpi-label">Taxa de Convers√£o</div>
            </div>
        </section>

        <!-- Placeholder para Modelo ML -->
        <section class="section-card" id="ml-section">
            <h2 class="section-title">ü§ñ Modelo de Predi√ß√£o (Em Desenvolvimento)</h2>
            <div class="ml-placeholder">
                <h3 style="font-weight: 800; margin-bottom: 1rem;">‚öôÔ∏è √Årea Reservada para Machine Learning</h3>
                <p style="margin-bottom: 0.5rem;">Quando implementado, o modelo ir√° analisar:</p>
                <ul style="list-style: none; padding: 0;">
                    <li>‚úì Ticket M√©dio</li>
                    <li>‚úì N√∫mero de Lojas</li>
                    <li>‚úì N√∫mero de Funcion√°rios</li>
                    <li>‚úì Segmento da Empresa</li>
                    <li>‚úì Local do Evento</li>
                    <li>‚úì Hist√≥rico de Convers√µes</li>
                </ul>
                <p style="margin-top: 1rem; font-weight: 700;">üéØ Previs√£o: Probabilidade de Avan√ßo (0-100%)</p>
            </div>
        </section>

        <!-- Loading -->
        <div id="loading" class="loading hidden">Carregando dados...</div>

        <!-- Cards de Empresas -->
        <section class="section-card">
            <h2 class="section-title">üìã Quadro de Agendamentos</h2>
            <div id="cards-container" class="cards-grid"></div>
        </section>
    </div>

    <!-- Modal para Edi√ß√£o -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Empresa</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content" id="modal-content"></div>
        </div>
    </div>

    <script>
        let allData = [];
        let currentRecordId = null;
        const API_URL = '/api/agendamentos';

        // Configurar data padr√£o
        document.getElementById('dataReuniao').valueAsDate = new Date();

        // Carregar dados
        async function loadData() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Erro ao carregar dados');
                
                const data = await response.json();
                allData = data.records || [];
                
                updateKPIs();
                renderCards();
                document.getElementById('kpis-section').classList.remove('hidden');
            } catch (error) {
                console.error('Erro:', error);
                Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os dados', 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Adicionar novo agendamento
        document.getElementById('agendamentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const dados = {
                responsavel: document.getElementById('responsavel').value,
                empresa: document.getElementById('empresa').value,
                dataReuniao: document.getElementById('dataReuniao').value,
                ticketMedio: parseFloat(document.getElementById('ticketMedio').value) || null,
                numeroLojas: parseInt(document.getElementById('numeroLojas').value) || null,
                numeroFuncionarios: parseInt(document.getElementById('numeroFuncionarios').value) || null,
                segmento: document.getElementById('segmento').value || null,
                localEvento: document.getElementById('localEvento').value || null
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) throw new Error('Erro ao criar agendamento');

                Swal.fire('Sucesso!', 'Agendamento criado com sucesso', 'success');
                
                // Limpar campos n√£o obrigat√≥rios
                document.getElementById('empresa').value = '';
                document.getElementById('ticketMedio').value = '';
                document.getElementById('numeroLojas').value = '';
                document.getElementById('numeroFuncionarios').value = '';
                document.getElementById('segmento').value = '';
                document.getElementById('localEvento').value = '';
                
                loadData();
            } catch (error) {
                console.error('Erro:', error);
                Swal.fire('Erro', 'N√£o foi poss√≠vel criar o agendamento', 'error');
            }
        });

        // Atualizar KPIs
        function updateKPIs() {
            const total = allData.length;
            const avancou = allData.filter(r => r.fields.StatusAvanco === 'Avan√ßou').length;
            const pendentes = allData.filter(r => r.fields.StatusAvanco === 'Pendente').length;
            const taxa = total > 0 ? ((avancou / total) * 100).toFixed(1) : 0;

            document.getElementById('total-agendamentos').textContent = total;
            document.getElementById('total-avancou').textContent = avancou;
            document.getElementById('total-pendentes').textContent = pendentes;
            document.getElementById('taxa-conversao').textContent = taxa + '%';
        }

        // Renderizar cards
        function renderCards() {
            const container = document.getElementById('cards-container');
            
            if (allData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhum agendamento cadastrado ainda</p>';
                return;
            }

            container.innerHTML = allData.map(record => {
                const f = record.fields;
                const status = f.StatusAvanco || 'Pendente';
                const statusClass = status === 'Avan√ßou' ? 'status-avancou' : 
                                   status === 'N√£o Avan√ßou' ? 'status-nao-avancou' : 'status-pendente';

                return `
                    <div class="empresa-card" onclick="openModal('${record.id}')">
                        <div class="empresa-nome">${f.Empresa}</div>
                        <div class="status-badge ${statusClass}">${status}</div>
                        
                        <div class="metric-row">
                            <div class="metric-item">
                                <div class="metric-label">Respons√°vel</div>
                                <div class="metric-value">${f.Responsavel}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Data Reuni√£o</div>
                                <div class="metric-value">${new Date(f.DataReuniao).toLocaleDateString('pt-BR')}</div>
                            </div>
                        </div>

                        ${f.TicketMedio || f.NumeroLojas ? `
                        <div class="metric-row">
                            ${f.TicketMedio ? `
                            <div class="metric-item">
                                <div class="metric-label">Ticket M√©dio</div>
                                <div class="metric-value">R$ ${f.TicketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                            </div>` : ''}
                            ${f.NumeroLojas ? `
                            <div class="metric-item">
                                <div class="metric-label">N¬∫ Lojas</div>
                                <div class="metric-value">${f.NumeroLojas}</div>
                            </div>` : ''}
                        </div>` : ''}

                        ${status === 'Pendente' ? `
                        <div class="probability-section">
                            <div class="probability-label">ü§ñ Probabilidade de Avan√ßo</div>
                            <div class="probability-value">--% (Modelo em treinamento)</div>
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Abrir modal
        function openModal(recordId) {
            currentRecordId = recordId;
            const record = allData.find(r => r.id === recordId);
            if (!record) return;

            const f = record.fields;
            document.getElementById('modal-title').textContent = f.Empresa;
            
            const fields = [
                { label: 'Respons√°vel', value: f.Responsavel, key: 'Responsavel' },
                { label: 'Data Reuni√£o', value: new Date(f.DataReuniao).toLocaleDateString('pt-BR'), key: 'DataReuniao' },
                { label: 'Status de Avan√ßo', value: f.StatusAvanco || 'Pendente', key: 'StatusAvanco', editable: true },
                { label: 'Ticket M√©dio', value: f.TicketMedio ? `R$ ${f.TicketMedio.toFixed(2)}` : 'N/A', key: 'TicketMedio', editable: true },
                { label: 'N√∫mero de Lojas', value: f.NumeroLojas || 'N/A', key: 'NumeroLojas', editable: true },
                { label: 'N√∫mero de Funcion√°rios', value: f.NumeroFuncionarios || 'N/A', key: 'NumeroFuncionarios', editable: true },
                { label: 'Segmento', value: f.Segmento || 'N/A', key: 'Segmento', editable: true },
                { label: 'Local do Evento', value: f.LocalEvento || 'N/A', key: 'LocalEvento', editable: true }
            ];

            document.getElementById('modal-content').innerHTML = fields.map(field => `
                <div class="field-group">
                    <label class="field-label">${field.label}</label>
                    <div class="field-value" ${field.editable ? `onclick="editField('${field.key}', '${field.value}')"` : ''}>
                        ${field.value}
                    </div>
                </div>
            `).join('');

            document.getElementById('modal-overlay').classList.add('active');
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            currentRecordId = null;
        }

        // Editar campo
        async function editField(fieldKey, currentValue) {
            let inputType = 'text';
            let inputOptions = {};

            // Configurar tipo de input baseado no campo
            if (fieldKey === 'StatusAvanco') {
                inputType = 'select';
                inputOptions = {
                    'Pendente': 'Pendente',
                    'Avan√ßou': 'Avan√ßou',
                    'N√£o Avan√ßou': 'N√£o Avan√ßou'
                };
            } else if (fieldKey === 'Segmento') {
                inputType = 'select';
                inputOptions = {
                    'Moda': 'Moda',
                    'Alimenta√ß√£o': 'Alimenta√ß√£o',
                    'Tecnologia': 'Tecnologia',
                    'Beleza': 'Beleza',
                    'Decora√ß√£o': 'Decora√ß√£o',
                    'Servi√ßos': 'Servi√ßos',
                    'Outros': 'Outros'
                };
            } else if (fieldKey === 'TicketMedio') {
                inputType = 'number';
            } else if (fieldKey === 'NumeroLojas' || fieldKey === 'NumeroFuncionarios') {
                inputType = 'number';
            }

            const { value: newValue } = await Swal.fire({
                title: `Editar ${fieldKey}`,
                input: inputType,
                inputOptions: inputOptions,
                inputValue: currentValue.replace('R$ ', '').replace('N/A', ''),
                showCancelButton: true,
                confirmButtonText: 'Salvar',
                cancelButtonText: 'Cancelar',
                customClass: {
                    popup: 'swal2-custom-popup',
                    title: 'swal2-custom-title',
                    input: 'swal2-custom-input',
                    confirmButton: 'swal2-custom-confirm',
                    cancelButton: 'swal2-custom-cancel'
                }
            });

            if (newValue !== undefined && newValue !== '') {
                await updateField(fieldKey, newValue);
            }
        }

        // Atualizar campo no Airtable
        async function updateField(fieldKey, value) {
            try {
                // Converter valores num√©ricos
                let processedValue = value;
                if (fieldKey === 'TicketMedio') {
                    processedValue = parseFloat(value);
                } else if (fieldKey === 'NumeroLojas' || fieldKey === 'NumeroFuncionarios') {
                    processedValue = parseInt(value);
                }

                const response = await fetch(API_URL, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recordId: currentRecordId,
                        fields: { [fieldKey]: processedValue }
                    })
                });

                if (!response.ok) throw new Error('Erro ao atualizar');

                Swal.fire('Sucesso!', 'Campo atualizado com sucesso', 'success');
                loadData();
                closeModal();
            } catch (error) {
                console.error('Erro:', error);
                Swal.fire('Erro', 'N√£o foi poss√≠vel atualizar o campo', 'error');
            }
        }

        // Exportar relat√≥rio em PNG
        async function exportReport() {
            const exportBtn = document.getElementById('export-btn');
            exportBtn.disabled = true;
            exportBtn.textContent = 'üìä Gerando Relat√≥rio...';

            try {
                // Criar container do relat√≥rio
                const reportContainer = document.createElement('div');
                reportContainer.className = 'report-container';
                document.body.appendChild(reportContainer);

                const dataAtual = new Date().toLocaleDateString('pt-BR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Calcular estat√≠sticas
                const total = allData.length;
                const avancou = allData.filter(r => r.fields.StatusAvanco === 'Avan√ßou').length;
                const naoAvancou = allData.filter(r => r.fields.StatusAvanco === 'N√£o Avan√ßou').length;
                const pendentes = allData.filter(r => r.fields.StatusAvanco === 'Pendente').length;
                const taxaConversao = total > 0 ? ((avancou / (avancou + naoAvancou || 1)) * 100).toFixed(1) : 0;

                // Estat√≠sticas por respons√°vel
                const porResponsavel = {};
                allData.forEach(r => {
                    const resp = r.fields.Responsavel;
                    if (!porResponsavel[resp]) {
                        porResponsavel[resp] = { total: 0, avancou: 0, pendentes: 0 };
                    }
                    porResponsavel[resp].total++;
                    if (r.fields.StatusAvanco === 'Avan√ßou') porResponsavel[resp].avancou++;
                    if (r.fields.StatusAvanco === 'Pendente') porResponsavel[resp].pendentes++;
                });

                // Estat√≠sticas por segmento
                const porSegmento = {};
                allData.forEach(r => {
                    const seg = r.fields.Segmento || 'N√£o definido';
                    if (!porSegmento[seg]) {
                        porSegmento[seg] = { total: 0, avancou: 0 };
                    }
                    porSegmento[seg].total++;
                    if (r.fields.StatusAvanco === 'Avan√ßou') porSegmento[seg].avancou++;
                });

                reportContainer.innerHTML = `
                    <div class="report-header">
                        <div class="report-title">Relat√≥rio de Agendamentos e An√°lise Preditiva</div>
                        <div style="opacity: 0.9; margin-top: 0.5rem;">${dataAtual}</div>
                    </div>

                    <div class="report-section">
                        <h3>üìä KPIs Gerais</h3>
                        <div class="report-grid">
                            <div class="report-kpi">
                                <div class="report-kpi-value">${total}</div>
                                <div class="report-kpi-label">Total Agendamentos</div>
                            </div>
                            <div class="report-kpi">
                                <div class="report-kpi-value">${avancou}</div>
                                <div class="report-kpi-label">Avan√ßaram</div>
                            </div>
                            <div class="report-kpi">
                                <div class="report-kpi-value">${pendentes}</div>
                                <div class="report-kpi-label">Pendentes</div>
                            </div>
                            <div class="report-kpi">
                                <div class="report-kpi-value">${taxaConversao}%</div>
                                <div class="report-kpi-label">Taxa de Convers√£o</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>üë• Desempenho por Respons√°vel</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Respons√°vel</th>
                                    <th>Total</th>
                                    <th>Avan√ßou</th>
                                    <th>Pendentes</th>
                                    <th>Taxa de Convers√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(porResponsavel).map(([resp, stats]) => {
                                    const taxa = stats.total > 0 ? ((stats.avancou / stats.total) * 100).toFixed(1) : 0;
                                    return `
                                        <tr>
                                            <td><strong>${resp}</strong></td>
                                            <td>${stats.total}</td>
                                            <td>${stats.avancou}</td>
                                            <td>${stats.pendentes}</td>
                                            <td>${taxa}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3>üè¢ An√°lise por Segmento</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Segmento</th>
                                    <th>Total</th>
                                    <th>Avan√ßou</th>
                                    <th>Taxa de Convers√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(porSegmento).sort((a, b) => b[1].total - a[1].total).map(([seg, stats]) => {
                                    const taxa = stats.total > 0 ? ((stats.avancou / stats.total) * 100).toFixed(1) : 0;
                                    return `
                                        <tr>
                                            <td><strong>${seg}</strong></td>
                                            <td>${stats.total}</td>
                                            <td>${stats.avancou}</td>
                                            <td>${taxa}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3>üéØ Top 5 Empresas (Ticket M√©dio)</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Posi√ß√£o</th>
                                    <th>Empresa</th>
                                    <th>Ticket M√©dio</th>
                                    <th>Status</th>
                                    <th>Respons√°vel</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allData
                                    .filter(r => r.fields.TicketMedio)
                                    .sort((a, b) => (b.fields.TicketMedio || 0) - (a.fields.TicketMedio || 0))
                                    .slice(0, 5)
                                    .map((record, index) => {
                                        const f = record.fields;
                                        const medals = ['ü•á', 'ü•à', 'ü•â', '4¬∫', '5¬∫'];
                                        return `
                                            <tr>
                                                <td style="text-align: center; font-size: 1.1rem;">${medals[index]}</td>
                                                <td><strong>${f.Empresa}</strong></td>
                                                <td>R$ ${f.TicketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                                <td>${f.StatusAvanco || 'Pendente'}</td>
                                                <td>${f.Responsavel}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3>ü§ñ Status do Modelo Preditivo</h3>
                        <div style="background: #fef3c7; border: 2px dashed #FDBB2D; border-radius: 0.75rem; padding: 1.5rem; text-align: center;">
                            <p style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;">‚öôÔ∏è Modelo em Desenvolvimento</p>
                            <p style="color: #4A5568;">O modelo de Machine Learning ser√° treinado com os dados coletados.</p>
                            <p style="color: #4A5568; margin-top: 0.5rem;">Vari√°veis: Ticket M√©dio, N¬∫ Lojas, N¬∫ Funcion√°rios, Segmento, Local</p>
                        </div>
                    </div>

                    <div class="report-footer">
                        Relat√≥rio gerado automaticamente pelo Sistema de An√°lise Preditiva - ${dataAtual}
                    </div>
                `;

                // Aguardar renderiza√ß√£o
                await new Promise(resolve => setTimeout(resolve, 500));

                // Capturar e baixar
                const canvas = await html2canvas(reportContainer, {
                    width: 1200,
                    height: reportContainer.scrollHeight,
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                // Remover container
                document.body.removeChild(reportContainer);

                // Download
                const link = document.createElement('a');
                link.download = `relatorio_agendamentos_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                Swal.fire('Sucesso!', 'Relat√≥rio exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar:', error);
                Swal.fire('Erro', 'N√£o foi poss√≠vel gerar o relat√≥rio', 'error');
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = 'üìä Exportar Relat√≥rio PNG';
            }
        }

        // Fechar modal ao clicar fora
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') closeModal();
        });

        // Inicializar
        loadData();

        // ========================================
        // √ÅREA RESERVADA PARA MODELO DE ML
        // ========================================
        
        // Fun√ß√£o placeholder para predi√ß√£o (ser√° implementada futuramente)
        function predictProbability(empresaData) {
            // TODO: Implementar modelo de Machine Learning
            // Exemplo de estrutura:
            /*
            const features = [
                empresaData.TicketMedio || 0,
                empresaData.NumeroLojas || 0,
                empresaData.NumeroFuncionarios || 0,
                encodeSegmento(empresaData.Segmento),
                encodeLocal(empresaData.LocalEvento)
            ];
            
            // Carregar modelo treinado (TensorFlow.js, ONNX, etc)
            const probability = model.predict(features);
            return probability;
            */
            
            return null; // Retorna null enquanto modelo n√£o est√° treinado
        }

        // Fun√ß√£o para treinar modelo quando houver dados suficientes
        async function trainModel() {
            // TODO: Implementar treinamento do modelo
            // Requisitos:
            // - M√≠nimo de dados para treino (ex: 100 registros com StatusAvanco definido)
            // - Split treino/teste
            // - Valida√ß√£o cruzada
            // - M√©tricas de performance (accuracy, precision, recall, F1-score)
            
            console.log('Fun√ß√£o de treinamento ser√° implementada quando houver dados suficientes');
        }
    </script>
</body>
</html>